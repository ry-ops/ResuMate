<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - ResuMate</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/analytics.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="analytics-dashboard" id="main-content" tabindex="-1">
        <!-- Header -->
        <div class="analytics-header">
            <h1>üìä Analytics Dashboard</h1>
            <p class="analytics-subtitle">Comprehensive resume and application insights</p>
        </div>

        <!-- Dashboard Controls -->
        <div class="dashboard-controls">
            <div class="date-range-selector">
                <button class="date-range-btn" data-range="7">7 Days</button>
                <button class="date-range-btn active" data-range="30">30 Days</button>
                <button class="date-range-btn" data-range="90">90 Days</button>
                <button class="date-range-btn" data-range="365">1 Year</button>
                <button class="date-range-btn" data-range="all">All Time</button>
            </div>
            <div class="dashboard-actions">
                <button class="theme-toggle" id="theme-toggle">
                    <span id="theme-icon">üåô</span>
                    <span>Dark Mode</span>
                </button>
                <button class="action-btn secondary" onclick="refreshDashboard()">
                    <span>üîÑ</span>
                    <span>Refresh</span>
                </button>
                <button class="action-btn" onclick="openExportModal()">
                    <span>üì•</span>
                    <span>Export Report</span>
                </button>
            </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="dashboard-grid">
            <!-- Total Score Metric -->
            <div class="metric-card">
                <div class="metric-card-header">
                    <span class="metric-card-title">Current ATS Score</span>
                    <div class="metric-card-icon primary">üìà</div>
                </div>
                <div class="metric-value" id="current-ats-score">--</div>
                <div class="metric-label">Latest resume score</div>
                <div class="metric-trend positive" id="score-trend">
                    <span>‚Üë</span>
                    <span>+0 from last version</span>
                </div>
            </div>

            <!-- Total Applications -->
            <div class="metric-card">
                <div class="metric-card-header">
                    <span class="metric-card-title">Total Applications</span>
                    <div class="metric-card-icon primary">üìù</div>
                </div>
                <div class="metric-value" id="total-applications">0</div>
                <div class="metric-label">Applications submitted</div>
                <div class="metric-trend neutral" id="applications-trend">
                    <span>‚û°Ô∏è</span>
                    <span>No change</span>
                </div>
            </div>

            <!-- Response Rate -->
            <div class="metric-card">
                <div class="metric-card-header">
                    <span class="metric-card-title">Response Rate</span>
                    <div class="metric-card-icon success">‚úÖ</div>
                </div>
                <div class="metric-value" id="response-rate">0%</div>
                <div class="metric-label">Responses received</div>
                <div class="metric-trend neutral" id="response-trend">
                    <span>‚û°Ô∏è</span>
                    <span>Industry avg: 15%</span>
                </div>
            </div>

            <!-- Total Interviews -->
            <div class="metric-card">
                <div class="metric-card-header">
                    <span class="metric-card-title">Interviews</span>
                    <div class="metric-card-icon warning">üíº</div>
                </div>
                <div class="metric-value" id="total-interviews">0</div>
                <div class="metric-label">Interview invitations</div>
                <div class="metric-trend neutral" id="interview-trend">
                    <span>‚û°Ô∏è</span>
                    <span>No change</span>
                </div>
            </div>
        </div>

        <!-- Score Progression Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">Resume Score Progression</h2>
                <p class="chart-subtitle">Track improvements over time</p>
            </div>
            <div class="chart-container large">
                <canvas id="score-progression-chart"></canvas>
            </div>
            <div id="no-score-data" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üìä</div>
                <h3 class="empty-state-title">No Score Data Yet</h3>
                <p class="empty-state-description">
                    Run ATS scans on your resume to start tracking score improvements
                </p>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="dashboard-grid two-column">
            <!-- Application Funnel -->
            <div class="chart-card">
                <div class="chart-header">
                    <h2 class="chart-title">Application Funnel</h2>
                    <p class="chart-subtitle">Conversion through stages</p>
                </div>
                <div class="chart-container">
                    <canvas id="funnel-chart"></canvas>
                </div>
            </div>

            <!-- Template Usage -->
            <div class="chart-card">
                <div class="chart-header">
                    <h2 class="chart-title">Template Usage</h2>
                    <p class="chart-subtitle">Most used templates</p>
                </div>
                <div class="chart-container">
                    <canvas id="template-chart"></canvas>
                </div>
                <div id="no-template-data" class="empty-state" style="display: none;">
                    <p>No template data available</p>
                </div>
            </div>
        </div>

        <!-- Keyword Analysis -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">Top Keywords by Frequency</h2>
                <p class="chart-subtitle">Most mentioned skills and terms</p>
            </div>
            <div class="chart-container">
                <canvas id="keyword-chart"></canvas>
            </div>
            <div id="no-keyword-data" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üîë</div>
                <h3 class="empty-state-title">No Keyword Data</h3>
                <p class="empty-state-description">
                    Keywords will appear as you scan and optimize your resume
                </p>
            </div>
        </div>

        <!-- Monthly Trends -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">Application Trends</h2>
                <p class="chart-subtitle">Last 6 months activity</p>
            </div>
            <div class="chart-container large">
                <canvas id="trends-chart"></canvas>
            </div>
        </div>

        <!-- Advanced Metrics -->
        <div class="dashboard-grid">
            <!-- Iteration Effectiveness -->
            <div class="metric-card">
                <div class="metric-card-header">
                    <span class="metric-card-title">Resume Iterations</span>
                    <div class="metric-card-icon primary">üîÑ</div>
                </div>
                <div class="metric-value" id="total-iterations">0</div>
                <div class="metric-label">Total versions created</div>
                <div class="progress-bar-container">
                    <div class="progress-label">
                        <span class="progress-label-text">Improvement Rate</span>
                        <span class="progress-label-value" id="improvement-rate">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill success" id="improvement-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- ROI Metric -->
            <div class="metric-card">
                <div class="metric-card-header">
                    <span class="metric-card-title">Application ROI</span>
                    <div class="metric-card-icon success">üí∞</div>
                </div>
                <div class="metric-value" id="roi-score">0</div>
                <div class="metric-label" id="roi-label">Efficiency rating</div>
                <div class="badge success" id="roi-badge">Excellent</div>
            </div>

            <!-- Avg Response Time -->
            <div class="metric-card">
                <div class="metric-card-header">
                    <span class="metric-card-title">Avg Response Time</span>
                    <div class="metric-card-icon warning">‚è±Ô∏è</div>
                </div>
                <div class="metric-value" id="avg-response-time">--</div>
                <div class="metric-label">Days to first response</div>
                <div class="metric-trend neutral" id="response-time-trend">
                    <span>‚û°Ô∏è</span>
                    <span>Industry avg: 14 days</span>
                </div>
            </div>

            <!-- Activity Score -->
            <div class="metric-card">
                <div class="metric-card-header">
                    <span class="metric-card-title">Activity Level</span>
                    <div class="metric-card-icon primary">üéØ</div>
                </div>
                <div class="metric-value" id="activity-score">--</div>
                <div class="metric-label">Updates per week</div>
                <div class="badge primary" id="activity-badge">Medium</div>
            </div>
        </div>

        <!-- Template Performance Comparison -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">Template Performance Comparison</h2>
                <p class="chart-subtitle">Average scores by template</p>
            </div>
            <div id="template-comparison-table">
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Template</th>
                            <th>Usage Count</th>
                            <th>Avg Score</th>
                            <th>Success Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="template-table-body">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <p>No template data available</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Keyword Effectiveness -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">Keyword Effectiveness</h2>
                <p class="chart-subtitle">Top performing keywords</p>
            </div>
            <div id="keyword-effectiveness-table">
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Keyword</th>
                            <th>Mentions</th>
                            <th>Avg Score</th>
                            <th>Trend</th>
                            <th>Effectiveness</th>
                        </tr>
                    </thead>
                    <tbody id="keyword-table-body">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <p>No keyword data available</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="export-modal" style="display: none;">
        <div class="export-modal-content">
            <div class="export-modal-header">
                <h2 class="export-modal-title">Export Analytics Report</h2>
            </div>
            <div class="export-options">
                <div class="export-option" data-format="pdf">
                    <div class="export-option-icon">üìÑ</div>
                    <div class="export-option-info">
                        <h3>PDF Report</h3>
                        <p>Comprehensive report with all charts and metrics</p>
                    </div>
                </div>
                <div class="export-option" data-format="csv">
                    <div class="export-option-icon">üìä</div>
                    <div class="export-option-info">
                        <h3>CSV Data</h3>
                        <p>Raw data for custom analysis</p>
                    </div>
                </div>
            </div>
            <div class="export-modal-actions">
                <button class="action-btn secondary" onclick="closeExportModal()">Cancel</button>
                <button class="action-btn" onclick="executeExport()">Export</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/tracker/storage.js"></script>
    <script src="js/tracker/analytics.js"></script>
    <script src="js/tracker/charts.js"></script>
    <script src="js/tracker/metrics.js"></script>
    <script>
        // Global variables
        let analytics;
        let charts;
        let metrics;
        let storage;
        let currentRange = 30;
        let selectedExportFormat = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupEventListeners();
            loadDashboardData();
        });

        function initializeDashboard() {
            // Initialize storage and analytics
            if (typeof TrackerStorage !== 'undefined') {
                storage = new TrackerStorage();
            }

            if (typeof TrackerAnalytics !== 'undefined') {
                analytics = new TrackerAnalytics(storage);
            }

            if (typeof AnalyticsCharts !== 'undefined') {
                charts = new AnalyticsCharts();
            }

            console.log('[Analytics Dashboard] Initialized');
        }

        function setupEventListeners() {
            // Date range selector
            document.querySelectorAll('.date-range-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentRange = this.dataset.range === 'all' ? 365 : parseInt(this.dataset.range);
                    loadDashboardData();
                });
            });

            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');

            themeToggle.addEventListener('click', function() {
                const html = document.documentElement;
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';

                html.setAttribute('data-theme', newTheme);
                themeIcon.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                themeToggle.querySelector('span:last-child').textContent =
                    newTheme === 'light' ? 'Dark Mode' : 'Light Mode';

                localStorage.setItem('analytics-theme', newTheme);
            });

            // Load saved theme
            const savedTheme = localStorage.getItem('analytics-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeIcon.textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';

            // Export options
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.export-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedExportFormat = this.dataset.format;
                });
            });
        }

        function loadDashboardData() {
            if (!analytics) return;

            // Get analytics data
            const analyticsData = analytics.getAnalyticsData();
            const stats = analytics.getAllStats();

            // Update key metrics
            updateKeyMetrics(analyticsData, stats);

            // Create charts
            createCharts(analyticsData, stats);

            // Update tables
            updateTables(analyticsData);

            // Update advanced metrics
            updateAdvancedMetrics(analyticsData);
        }

        function updateKeyMetrics(analyticsData, stats) {
            // Current ATS Score
            const scoreHistory = analytics.getScoreHistory(currentRange);
            if (scoreHistory.length > 0) {
                const latestScore = scoreHistory[scoreHistory.length - 1];
                document.getElementById('current-ats-score').textContent = latestScore.atsScore + '%';

                if (scoreHistory.length > 1) {
                    const previousScore = scoreHistory[scoreHistory.length - 2];
                    const change = latestScore.atsScore - previousScore.atsScore;
                    const trendElement = document.getElementById('score-trend');

                    if (change > 0) {
                        trendElement.className = 'metric-trend positive';
                        trendElement.innerHTML = `<span>‚Üë</span><span>+${change} from last version</span>`;
                    } else if (change < 0) {
                        trendElement.className = 'metric-trend negative';
                        trendElement.innerHTML = `<span>‚Üì</span><span>${change} from last version</span>`;
                    } else {
                        trendElement.className = 'metric-trend neutral';
                        trendElement.innerHTML = `<span>‚û°Ô∏è</span><span>No change</span>`;
                    }
                }
            } else {
                document.getElementById('current-ats-score').textContent = '--';
            }

            // Application metrics
            document.getElementById('total-applications').textContent = stats.overview.total;
            document.getElementById('response-rate').textContent = stats.rates.responseRate + '%';
            document.getElementById('total-interviews').textContent =
                stats.byStatus.interview + stats.byStatus['final-round'];
        }

        function createCharts(analyticsData, stats) {
            if (!charts) return;

            // Score Progression Chart
            const scoreHistory = analytics.getScoreHistory(currentRange);
            if (scoreHistory.length > 0) {
                charts.createScoreProgressionChart('score-progression-chart', scoreHistory);
                document.getElementById('no-score-data').style.display = 'none';
            } else {
                document.getElementById('no-score-data').style.display = 'block';
            }

            // Application Funnel Chart
            const funnelData = {
                applied: stats.byStatus.applied || 0,
                phoneScreen: stats.byStatus['phone-screen'] || 0,
                interview: stats.byStatus.interview || 0,
                finalRound: stats.byStatus['final-round'] || 0,
                offer: stats.byStatus.offer || 0
            };
            charts.createApplicationFunnelChart('funnel-chart', funnelData);

            // Template Usage Chart
            const templateStats = analytics.getTemplateStats();
            if (templateStats.length > 0) {
                charts.createTemplateUsageChart('template-chart', templateStats);
                document.getElementById('no-template-data').style.display = 'none';
            } else {
                document.getElementById('no-template-data').style.display = 'block';
            }

            // Keyword Chart
            const keywordTrends = analytics.getKeywordTrends(10);
            if (keywordTrends.length > 0) {
                charts.createKeywordFrequencyChart('keyword-chart', keywordTrends);
                document.getElementById('no-keyword-data').style.display = 'none';
            } else {
                document.getElementById('no-keyword-data').style.display = 'block';
            }

            // Monthly Trends Chart
            charts.createMonthlyTrendsChart('trends-chart', stats.trends);
        }

        function updateTables(analyticsData) {
            // Template comparison table
            const templateStats = analytics.getTemplateStats();
            const templateTableBody = document.getElementById('template-table-body');

            if (templateStats.length > 0) {
                templateTableBody.innerHTML = templateStats.map(t => `
                    <tr>
                        <td><strong>${formatTemplateName(t.templateId)}</strong></td>
                        <td>${t.usageCount}</td>
                        <td>${t.avgScore}%</td>
                        <td>${t.successRate}%</td>
                        <td>
                            <span class="badge ${t.avgScore >= 80 ? 'success' : t.avgScore >= 60 ? 'warning' : 'danger'}">
                                ${t.avgScore >= 80 ? 'Excellent' : t.avgScore >= 60 ? 'Good' : 'Needs Work'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }

            // Keyword effectiveness table
            if (typeof AdvancedMetrics !== 'undefined') {
                metrics = new AdvancedMetrics(analyticsData);
                const keywordEffectiveness = metrics.calculateKeywordEffectiveness();
                const keywordTableBody = document.getElementById('keyword-table-body');

                if (keywordEffectiveness.topPerformers.length > 0) {
                    keywordTableBody.innerHTML = keywordEffectiveness.topPerformers.map(k => `
                        <tr>
                            <td><strong>${k.keyword}</strong></td>
                            <td>${k.mentions}</td>
                            <td>${k.avgScore}%</td>
                            <td>
                                ${k.trendScore > 1.2 ? 'üìà Trending' :
                                  k.trendScore < 0.8 ? 'üìâ Declining' : '‚û°Ô∏è Stable'}
                            </td>
                            <td>
                                <span class="badge ${k.effectiveness > 100 ? 'success' : 'primary'}">
                                    ${Math.round(k.effectiveness)}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }

        function updateAdvancedMetrics(analyticsData) {
            if (!metrics) return;

            // Iteration effectiveness
            const iteration = metrics.calculateIterationEffectiveness();
            document.getElementById('total-iterations').textContent = iteration.totalIterations;
            document.getElementById('improvement-rate').textContent = iteration.effectiveness + '%';
            document.getElementById('improvement-bar').style.width = iteration.effectiveness + '%';

            // ROI
            const roi = metrics.calculateROI();
            document.getElementById('roi-score').textContent = roi.roi.toFixed(1);
            document.getElementById('roi-label').textContent = roi.efficiency;
            const roiBadge = document.getElementById('roi-badge');
            roiBadge.textContent = roi.efficiency;
            roiBadge.className = 'badge ' +
                (roi.efficiency === 'Excellent' ? 'success' :
                 roi.efficiency === 'Good' ? 'primary' : 'warning');

            // Response time
            const stats = analytics.getAllStats();
            if (stats.timing.avgTimeToResponse > 0) {
                document.getElementById('avg-response-time').textContent =
                    stats.timing.avgTimeToResponse + ' days';
            }

            // Activity
            const timeMetrics = metrics.calculateTimeBasedMetrics(currentRange);
            document.getElementById('activity-score').textContent = timeMetrics.productivity;
            const activityBadge = document.getElementById('activity-badge');
            activityBadge.textContent = timeMetrics.activity.charAt(0).toUpperCase() +
                                       timeMetrics.activity.slice(1);
            activityBadge.className = 'badge ' +
                (timeMetrics.activity === 'high' ? 'success' :
                 timeMetrics.activity === 'medium' ? 'primary' : 'warning');
        }

        function refreshDashboard() {
            loadDashboardData();
            console.log('[Analytics Dashboard] Refreshed');
        }

        function openExportModal() {
            document.getElementById('export-modal').style.display = 'flex';
        }

        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
            selectedExportFormat = null;
            document.querySelectorAll('.export-option').forEach(o => o.classList.remove('selected'));
        }

        function executeExport() {
            if (!selectedExportFormat) {
                alert('Please select an export format');
                return;
            }

            if (selectedExportFormat === 'pdf') {
                exportToPDF();
            } else if (selectedExportFormat === 'csv') {
                exportToCSV();
            }

            closeExportModal();
        }

        function exportToPDF() {
            window.print();
        }

        function exportToCSV() {
            const analyticsData = analytics.getAnalyticsData();

            // Score history CSV
            let csv = 'Date,ATS Score,Polish Score,Template\n';
            analyticsData.resumeScores.forEach(score => {
                csv += `${score.date},${score.atsScore},${score.polishScore},${score.templateId}\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resumate-analytics-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function formatTemplateName(templateId) {
            const names = {
                'classic': 'Classic',
                'modern': 'Modern',
                'professional': 'Professional',
                'creative': 'Creative',
                'minimal': 'Minimal',
                'executive': 'Executive',
                'technical': 'Technical'
            };
            return names[templateId] || templateId;
        }
    </script>
    <script src="js/navigation/loader.js"></script>
</body>
</html>
