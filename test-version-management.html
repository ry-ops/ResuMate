<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version Management Tests - ResuMate</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/navigation.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
            background: #f9fafb;
        }
        .test-header {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .test-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .test-result {
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-pass {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #047857;
        }
        .test-fail {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #dc2626;
        }
        .test-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #1e40af;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.5rem;
        }
        button:hover {
            background: #2563eb;
        }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-card {
            padding: 1rem;
            background: #f3f4f6;
            border-radius: 6px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body id="main-content" tabindex="-1">
    <div class="test-header">
        <h1>Version Management System Tests</h1>
        <p>Comprehensive testing for Worker 14 - resumate-version-manager</p>
        <div style="margin-top: 1rem;">
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="clearData()">Clear Test Data</button>
            <button onclick="location.href='versions.html?demo=true'">View UI Demo</button>
        </div>
    </div>

    <div id="test-results"></div>

    <!-- Load Scripts -->
    <script src="js/versions/storage.js"></script>
    <script src="js/versions/manager.js"></script>
    <script src="js/versions/diff.js"></script>
    <script src="js/versions/merger.js"></script>

    <script>
        let testResults = [];
        let passCount = 0;
        let failCount = 0;

        function log(message, type = 'info') {
            testResults.push({ message, type });
            return type === 'pass';
        }

        function assert(condition, message) {
            if (condition) {
                log('✅ ' + message, 'pass');
                passCount++;
                return true;
            } else {
                log('❌ ' + message, 'fail');
                failCount++;
                return false;
            }
        }

        function clearData() {
            localStorage.clear();
            testResults = [];
            passCount = 0;
            failCount = 0;
            document.getElementById('test-results').innerHTML = '<div class="test-section"><p>Test data cleared. Ready for testing.</p></div>';
        }

        function displayResults() {
            const container = document.getElementById('test-results');

            // Summary
            const totalTests = passCount + failCount;
            const passRate = totalTests > 0 ? ((passCount / totalTests) * 100).toFixed(1) : 0;

            let html = `
                <div class="test-section">
                    <h2>Test Summary</h2>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${totalTests}</div>
                            <div class="stat-label">Total Tests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #10b981;">${passCount}</div>
                            <div class="stat-label">Passed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #ef4444;">${failCount}</div>
                            <div class="stat-label">Failed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: ${passRate > 90 ? '#10b981' : '#f59e0b'};">${passRate}%</div>
                            <div class="stat-label">Pass Rate</div>
                        </div>
                    </div>
                </div>
            `;

            // Test results
            html += '<div class="test-section"><h2>Test Results</h2>';
            testResults.forEach(result => {
                const className = result.type === 'pass' ? 'test-pass' : result.type === 'fail' ? 'test-fail' : 'test-info';
                html += `<div class="test-result ${className}">${result.message}</div>`;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function runAllTests() {
            testResults = [];
            passCount = 0;
            failCount = 0;

            log('Starting Version Management Tests...', 'info');

            // Clear previous test data
            localStorage.clear();

            try {
                testStorage();
                testManager();
                testDiff();
                testMerger();
                testAcceptanceCriteria();
            } catch (error) {
                log('Fatal Error: ' + error.message, 'fail');
                console.error(error);
            }

            displayResults();
        }

        function testStorage() {
            log('=== Testing Version Storage ===', 'info');

            const storage = new VersionStorage();

            // Test 1: Save version
            const version1 = {
                id: 'test-1',
                type: 'base',
                name: 'Test Base Resume',
                status: 'draft',
                resumeData: { test: true }
            };
            const saved = storage.saveVersion(version1);
            assert(saved.id === 'test-1', 'Save version');
            assert(saved.createdAt, 'Auto-generate createdAt');
            assert(saved.updatedAt, 'Auto-generate updatedAt');

            // Test 2: Get version
            const retrieved = storage.getVersion('test-1');
            assert(retrieved && retrieved.name === 'Test Base Resume', 'Get version by ID');

            // Test 3: Get all versions
            const all = storage.getAllVersions();
            assert(all.length === 1, 'Get all versions');

            // Test 4: Save multiple versions
            storage.saveVersion({ id: 'test-2', type: 'tailored', name: 'Tailored 1', baseResumeId: 'test-1', status: 'draft' });
            storage.saveVersion({ id: 'test-3', type: 'tailored', name: 'Tailored 2', baseResumeId: 'test-1', status: 'applied' });
            assert(storage.getAllVersions().length === 3, 'Save multiple versions');

            // Test 5: Get by type
            const baseVersions = storage.getVersionsByType('base');
            assert(baseVersions.length === 1, 'Get versions by type');

            // Test 6: Get tailored versions
            const tailored = storage.getTailoredVersions('test-1');
            assert(tailored.length === 2, 'Get tailored versions for base');

            // Test 7: Search
            storage.saveVersion({ id: 'test-4', type: 'base', name: 'Software Engineer Resume', status: 'draft' });
            const searchResults = storage.searchVersions('software');
            assert(searchResults.length >= 1, 'Search versions');

            // Test 8: Filter
            const filtered = storage.filterVersions({ type: 'tailored', status: 'applied' });
            assert(filtered.length === 1, 'Filter versions');

            // Test 9: Sort
            const sorted = storage.sortVersions(storage.getAllVersions(), 'name', 'asc');
            assert(sorted[0].name <= sorted[1].name, 'Sort versions');

            // Test 10: Delete
            const deleted = storage.deleteVersion('test-4');
            assert(deleted === true, 'Delete version');

            // Test 11: Storage usage
            const usage = storage.getStorageUsage();
            assert(usage.bytes > 0, 'Calculate storage usage');

            // Test 12: Export
            const exported = storage.exportVersions();
            assert(exported && JSON.parse(exported).length > 0, 'Export versions to JSON');

            log('Storage tests completed', 'info');
        }

        function testManager() {
            log('=== Testing Version Manager ===', 'info');

            const manager = new VersionManager();

            // Test 1: Create base version
            const base = manager.createBaseVersion({
                name: 'My Base Resume',
                templateId: 'modern',
                notes: 'Test notes',
                resumeData: { personal: { name: 'John Doe' } }
            });
            assert(base && base.type === 'base', 'Create base version');
            assert(base.status === 'draft', 'Default status is draft');

            // Test 2: Create tailored version
            const tailored = manager.createTailoredVersion(base.id, {
                targetCompany: 'Test Corp',
                targetRole: 'Software Engineer',
                jobDescription: 'Great opportunity'
            });
            assert(tailored && tailored.type === 'tailored', 'Create tailored version');
            assert(tailored.baseResumeId === base.id, 'Tailored links to base');

            // Test 3: Clone version
            const cloned = manager.cloneVersion(base.id);
            assert(cloned && cloned.id !== base.id, 'Clone version with new ID');
            assert(cloned.name.includes('Copy'), 'Clone has Copy in name');

            // Test 4: Update version
            const updated = manager.updateVersion(base.id, { notes: 'Updated notes' });
            assert(updated.notes === 'Updated notes', 'Update version');

            // Test 5: Update status
            manager.updateStatus(tailored.id, 'applied');
            const statusUpdated = manager.getVersion(tailored.id);
            assert(statusUpdated.status === 'applied', 'Update status');
            assert(statusUpdated.appliedAt, 'Set appliedAt on status change');

            // Test 6: Toggle favorite
            manager.toggleFavorite(base.id);
            assert(manager.getVersion(base.id).favorite === true, 'Toggle favorite on');
            manager.toggleFavorite(base.id);
            assert(manager.getVersion(base.id).favorite === false, 'Toggle favorite off');

            // Test 7: Archive
            manager.archiveVersion(cloned.id);
            assert(manager.getVersion(cloned.id).archived === true, 'Archive version');

            // Test 8: Tags
            manager.addTag(base.id, 'engineering');
            assert(manager.getVersion(base.id).tags.includes('engineering'), 'Add tag');
            manager.removeTag(base.id, 'engineering');
            assert(!manager.getVersion(base.id).tags.includes('engineering'), 'Remove tag');

            // Test 9: Version tree
            const tree = manager.getVersionTree();
            assert(tree.length >= 1, 'Get version tree');
            assert(tree[0].children, 'Tree has children array');

            // Test 10: Statistics
            const stats = manager.getStatistics();
            assert(stats.total > 0, 'Get statistics');
            assert(stats.byStatus, 'Statistics include status breakdown');

            log('Manager tests completed', 'info');
        }

        function testDiff() {
            log('=== Testing Diff Engine ===', 'info');

            const diff = new VersionDiff();
            const manager = new VersionManager();

            // Create test versions
            const base = {
                id: 'diff-base',
                name: 'Base',
                resumeData: {
                    personal: { name: 'John Doe', email: 'john@example.com' },
                    summary: 'Experienced engineer',
                    skills: ['JavaScript', 'Python']
                }
            };

            const modified = {
                id: 'diff-modified',
                name: 'Modified',
                resumeData: {
                    personal: { name: 'John Doe', email: 'newemail@example.com' },
                    summary: 'Senior experienced engineer',
                    skills: ['JavaScript', 'Python', 'React']
                }
            };

            // Test 1: Compare versions
            const comparison = diff.compareVersions(base, modified);
            assert(comparison && comparison.resumeData, 'Compare versions');

            // Test 2: Detect modifications
            assert(comparison.resumeData.personal.type === diff.diffTypes.MODIFIED, 'Detect modified section');

            // Test 3: Calculate statistics
            assert(comparison.statistics && comparison.statistics.words, 'Calculate word statistics');

            // Test 4: Generate summary
            assert(comparison.summary && comparison.summary.sectionsChanged >= 0, 'Generate change summary');

            // Test 5: Text diff
            const textDiff = diff.getTextDiff('Hello world', 'Hello there world');
            assert(textDiff.length > 0, 'Generate text diff');

            // Test 6: Similarity calculation
            const similarity = diff.calculateSimilarity('test string', 'test string');
            assert(similarity === 100, 'Calculate 100% similarity');

            const similarity2 = diff.calculateSimilarity('abc', 'xyz');
            assert(similarity2 < 100, 'Calculate partial similarity');

            log('Diff engine tests completed', 'info');
        }

        function testMerger() {
            log('=== Testing Merge Engine ===', 'info');

            const manager = new VersionManager();
            const merger = new VersionMerger(manager);

            // Create versions for merge testing
            const base = manager.createBaseVersion({
                name: 'Merge Base',
                resumeData: {
                    summary: 'Original summary',
                    skills: ['Skill A', 'Skill B']
                }
            });

            const tailored = manager.createTailoredVersion(base.id, {
                targetCompany: 'Merge Corp',
                targetRole: 'Engineer',
                resumeData: {
                    summary: 'Tailored summary',
                    skills: ['Skill A', 'Skill B', 'Skill C']
                }
            });

            // Test 1: Validate merge
            const validation = merger.validateMerge(tailored.id);
            assert(validation.valid === true, 'Validate merge');

            // Test 2: Get merge preview
            const preview = merger.getMergePreview(tailored.id);
            assert(preview && preview.preview === true, 'Get merge preview');
            assert(preview.mergePlan, 'Preview includes merge plan');

            // Test 3: Create backup
            const backup = merger.createBackup(base.id);
            assert(backup && backup.id !== base.id, 'Create backup before merge');

            // Test 4: Execute merge
            const result = merger.mergeTailoredToBase(tailored.id);
            assert(result && result.success === true, 'Execute merge');
            assert(result.appliedChanges, 'Merge returns applied changes');

            log('Merger tests completed', 'info');
        }

        function testAcceptanceCriteria() {
            log('=== Testing Acceptance Criteria ===', 'info');

            const manager = new VersionManager();
            const diff = new VersionDiff();
            const merger = new VersionMerger(manager);

            // AC1: Create base and tailored versions
            const base = manager.createBaseVersion({ name: 'AC Test Base', resumeData: {} });
            const tailored = manager.createTailoredVersion(base.id, {
                targetCompany: 'AC Corp',
                targetRole: 'AC Role'
            });
            assert(base && tailored, 'AC1: Create base and tailored versions');

            // AC2: Version tree navigation
            const tree = manager.getVersionTree();
            const baseInTree = tree.find(b => b.id === base.id);
            assert(baseInTree && baseInTree.children.some(t => t.id === tailored.id),
                'AC2: Version tree navigation working');

            // AC3: Compare versions side-by-side
            const comparison = diff.compareVersions(base, tailored);
            assert(comparison && comparison.resumeData && comparison.summary,
                'AC3: Compare versions side-by-side');

            // AC4: Clone and modify versions
            const cloned = manager.cloneVersion(base.id, { name: 'Cloned' });
            manager.updateVersion(cloned.id, { notes: 'Modified clone' });
            assert(cloned && manager.getVersion(cloned.id).notes === 'Modified clone',
                'AC4: Clone and modify versions');

            // AC5: Track application status
            manager.updateStatus(tailored.id, 'applied');
            manager.updateStatus(tailored.id, 'interviewing');
            const tracked = manager.getVersion(tailored.id);
            assert(tracked.status === 'interviewing' && tracked.appliedAt,
                'AC5: Track application status');

            // AC6: Merge changes back to base
            const mergeResult = merger.mergeTailoredToBase(tailored.id);
            assert(mergeResult && mergeResult.success,
                'AC6: Merge changes back to base');

            // AC7: Search and filter functional
            const searchResults = manager.searchVersions('AC');
            const filtered = manager.filterVersions({ type: 'tailored' });
            assert(searchResults.length > 0 && filtered.length > 0,
                'AC7: Search and filter functional');

            // AC8: localStorage persistence
            const storage = manager.storage;
            const beforeCount = storage.getAllVersions().length;
            storage.saveVersion({ id: 'persist-test', type: 'base', name: 'Persist', status: 'draft' });
            const afterCount = storage.getAllVersions().length;
            const persisted = storage.getVersion('persist-test');
            assert(afterCount > beforeCount && persisted,
                'AC8: localStorage persistence working');

            log('All acceptance criteria tests completed', 'info');
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            console.log('Version Management Test Suite Loaded');
            console.log('Click "Run All Tests" to begin testing');
        });
    </script>
    <script src="js/navigation/loader.js"></script>
</body>
</html>
