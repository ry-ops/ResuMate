<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResuMate - Resume Builder Workflow</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/workflow.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#workflow-main" class="skip-to-main">Skip to main content</a>

    <!-- Navigation Bar -->
    <nav class="resumate-navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">
                <span class="navbar-logo">üìÑ</span>
                <span class="navbar-title">ResuMate</span>
            </a>

            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <span class="nav-link-icon">üè†</span>
                        Home
                    </a>
                </li>
                <li class="nav-item">
                    <a href="workflow.html" class="nav-link active">
                        <span class="nav-link-icon">‚ú®</span>
                        Resume Builder
                    </a>
                </li>
            </ul>

            <div class="navbar-actions">
                <button class="nav-theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span class="theme-icon-sun">‚òÄÔ∏è</span>
                    <span class="theme-icon-moon">üåô</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Workflow Container -->
    <main id="workflow-main" class="workflow-container" tabindex="-1">
        <!-- Progress Indicator -->
        <div class="workflow-progress" role="navigation" aria-label="Workflow progress">
            <div class="progress-dots">
                <button
                    class="progress-dot active"
                    data-step="1"
                    aria-label="Step 1: Upload Resume"
                    aria-current="step"
                    disabled>
                    <span class="progress-number">1</span>
                    <span class="progress-label">Upload</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="2"
                    aria-label="Step 2: Analysis (locked)"
                    disabled>
                    <span class="progress-number">2</span>
                    <span class="progress-label">Analyze</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="3"
                    aria-label="Step 3: Job Tailoring (locked)"
                    disabled>
                    <span class="progress-number">3</span>
                    <span class="progress-label">Tailor</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="4"
                    aria-label="Step 4: Edit Resume (locked)"
                    disabled>
                    <span class="progress-number">4</span>
                    <span class="progress-label">Edit</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="5"
                    aria-label="Step 5: Export (locked)"
                    disabled>
                    <span class="progress-number">5</span>
                    <span class="progress-label">Export</span>
                </button>
            </div>
        </div>

        <!-- Workflow Steps Container -->
        <div class="workflow-steps">
            <!-- Step 1: Upload Resume -->
            <section id="step-upload" class="workflow-step active" aria-labelledby="step-upload-title">
                <div class="step-header">
                    <h1 id="step-upload-title" class="step-title">
                        <span class="step-icon">üìÑ</span>
                        Upload Resume & Job Description
                    </h1>
                    <p class="step-description">
                        Start by uploading your resume and adding the job description you're applying for.
                    </p>
                </div>

                <div class="step-content">
                    <!-- Resume Input -->
                    <div class="card">
                        <h2 style="margin-bottom: 1rem;">üìÑ Your Resume</h2>
                        <div class="input-group">
                            <label for="resume-file" class="file-upload-label">
                                <span class="upload-icon">üìé</span>
                                Upload Resume (PDF, DOC, DOCX, TXT)
                                <input type="file" id="resume-file" accept=".pdf,.doc,.docx,.txt">
                            </label>

                            <div class="divider">OR</div>

                            <label for="resume-text" class="sr-only">Paste your resume text</label>
                            <textarea
                                id="resume-text"
                                placeholder="Paste your resume text here..."
                                rows="10"
                                aria-describedby="resume-help"></textarea>
                            <small id="resume-help" class="help-text">
                                Your resume data is processed securely and never stored permanently.
                            </small>
                        </div>
                    </div>

                    <!-- Job Description Input -->
                    <div class="card" style="margin-top: 2rem;">
                        <h2 style="margin-bottom: 1rem;">üíº Job Description</h2>
                        <div class="input-group">
                            <div class="job-url-import">
                                <label for="job-url">
                                    üîó Import from URL (LinkedIn, Indeed, etc.)
                                </label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input
                                        type="url"
                                        id="job-url"
                                        placeholder="https://linkedin.com/jobs/view/..."
                                        style="flex: 1; padding: 0.875rem; font-size: 1rem;">
                                    <button type="button" id="import-job-btn" class="btn-secondary" style="min-width: 100px;">
                                        Import
                                    </button>
                                </div>
                                <small id="job-url-status" style="margin-top: 0.5rem; display: block;"></small>
                            </div>

                            <div class="divider">OR</div>

                            <label for="job-text" class="sr-only">Paste job description</label>
                            <textarea
                                id="job-text"
                                placeholder="Paste the job description here..."
                                rows="8"
                                aria-describedby="job-help"></textarea>
                            <small id="job-help" class="help-text">
                                Include the full job description for best resume analysis results.
                            </small>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        id="step-1-continue"
                        class="btn-primary btn-continue"
                        disabled
                        aria-label="Continue to analysis step">
                        Continue to Analysis
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 2: Analysis -->
            <section id="step-analyze" class="workflow-step locked" aria-labelledby="step-analyze-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-analyze-title" class="step-title">
                        <span class="step-icon">üîç</span>
                        Resume Analysis
                    </h1>
                    <p class="step-description">
                        We'll analyze your resume for ATS compatibility, keyword optimization, and overall quality.
                    </p>
                </div>

                <div class="step-content">
                    <!-- Loading State -->
                    <div id="analyze-loading" class="loading-state" style="display: none;">
                        <div class="spinner"></div>
                        <p>‚ú® AI is working its magic...</p>
                    </div>

                    <!-- Analysis Results (populated by JS) -->
                    <div id="analyze-results" class="analysis-results" style="display: none;">
                        <!-- Results will be inserted here by workflow-ui.js -->
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to upload step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-2-continue"
                        class="btn-primary btn-continue"
                        disabled
                        aria-label="Continue to job tailoring step">
                        Continue to Tailoring
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 3: Job Tailoring -->
            <section id="step-tailor" class="workflow-step locked" aria-labelledby="step-tailor-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-tailor-title" class="step-title">
                        <span class="step-icon">üéØ</span>
                        Tailor to Job Description
                    </h1>
                    <p class="step-description">
                        Optimize your resume for a specific job by providing the job description.
                    </p>
                </div>

                <div class="step-content">
                    <div class="card">
                        <div class="input-group">
                            <div class="job-url-import">
                                <label for="job-url">
                                    üîó Import from URL (LinkedIn, Indeed, etc.)
                                </label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input
                                        type="url"
                                        id="job-url"
                                        placeholder="https://linkedin.com/jobs/view/..."
                                        style="flex: 1;">
                                    <button type="button" id="import-job-btn" class="btn-secondary">
                                        Import
                                    </button>
                                </div>
                                <small id="job-url-status" style="margin-top: 0.5rem; display: block;"></small>
                            </div>

                            <div class="divider">OR</div>

                            <label for="job-text" class="sr-only">Paste job description</label>
                            <textarea
                                id="job-text"
                                placeholder="Paste the job description here..."
                                rows="10"
                                aria-describedby="job-help"></textarea>
                            <small id="job-help" class="help-text">
                                Include the full job description for best results.
                            </small>
                        </div>

                        <div class="tailor-options">
                            <h3>Tailoring Options</h3>
                            <label class="checkbox-label">
                                <input type="checkbox" id="tailor-keywords" checked>
                                <span>Optimize keywords for ATS</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="tailor-skills" checked>
                                <span>Match required skills</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="tailor-experience">
                                <span>Emphasize relevant experience</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to analysis step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-3-skip"
                        class="btn-secondary"
                        aria-label="Skip job tailoring">
                        Skip This Step
                    </button>
                    <button
                        id="step-3-continue"
                        class="btn-primary btn-continue"
                        disabled
                        aria-label="Continue to edit resume step">
                        Tailor Resume
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 4: Edit Resume -->
            <section id="step-edit" class="workflow-step locked" aria-labelledby="step-edit-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-edit-title" class="step-title">
                        <span class="step-icon">‚úèÔ∏è</span>
                        Edit & Preview
                    </h1>
                    <p class="step-description">
                        Make final edits to your resume and preview how it looks.
                    </p>
                </div>

                <div class="step-content">
                    <div class="editor-container">
                        <!-- Split view: editor on left, preview on right -->
                        <div class="editor-panel">
                            <div class="editor-toolbar">
                                <button class="toolbar-btn" title="Bold">
                                    <strong>B</strong>
                                </button>
                                <button class="toolbar-btn" title="Italic">
                                    <em>I</em>
                                </button>
                                <button class="toolbar-btn" title="Bullet List">
                                    ‚Ä¢
                                </button>
                            </div>
                            <div id="resume-editor" contenteditable="true" class="resume-editor" role="textbox" aria-label="Resume editor">
                                <!-- Editable resume content -->
                            </div>
                        </div>

                        <div class="preview-panel">
                            <div class="preview-toolbar">
                                <select id="template-select" aria-label="Select resume template">
                                    <option value="classic">Classic</option>
                                    <option value="modern">Modern</option>
                                    <option value="creative">Creative</option>
                                </select>
                            </div>
                            <div id="resume-preview" class="resume-preview">
                                <!-- Live preview -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to tailoring step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-4-continue"
                        class="btn-primary btn-continue"
                        aria-label="Continue to export step">
                        Continue to Export
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 5: Export -->
            <section id="step-export" class="workflow-step locked" aria-labelledby="step-export-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-export-title" class="step-title">
                        <span class="step-icon">üì•</span>
                        Export Your Resume
                    </h1>
                    <p class="step-description">
                        Download your optimized resume in your preferred format.
                    </p>
                </div>

                <div class="step-content">
                    <div class="export-options">
                        <div class="export-card" data-format="pdf">
                            <div class="export-icon">üìÑ</div>
                            <h3>PDF Document</h3>
                            <p>Best for job applications</p>
                            <button class="btn-export" data-format="pdf">
                                Download PDF
                            </button>
                        </div>

                        <div class="export-card" data-format="docx">
                            <div class="export-icon">üìù</div>
                            <h3>Word Document</h3>
                            <p>Editable format</p>
                            <button class="btn-export" data-format="docx">
                                Download DOCX
                            </button>
                        </div>

                        <div class="export-card" data-format="txt">
                            <div class="export-icon">üìã</div>
                            <h3>Plain Text</h3>
                            <p>ATS-friendly format</p>
                            <button class="btn-export" data-format="txt">
                                Download TXT
                            </button>
                        </div>
                    </div>

                    <div class="export-success" id="export-success" style="display: none;">
                        <div class="success-icon">‚úÖ</div>
                        <h2>Resume Ready!</h2>
                        <p>Your optimized resume has been downloaded successfully.</p>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to edit step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-5-finish"
                        class="btn-primary"
                        aria-label="Start a new resume">
                        Start New Resume
                    </button>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <p>Built with ‚ù§Ô∏è using Claude AI | <a href="https://github.com/ry-ops/ResuMate" target="_blank">GitHub</a></p>
    </footer>

    <!-- Core Dependencies -->
    <script src="js/core/data-bridge.js"></script>

    <!-- Export Libraries (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Export Modules -->
    <script src="js/export/pdf-export.js"></script>
    <script src="js/export/docx-export.js"></script>
    <script src="js/export/formats.js"></script>
    <script src="js/export/export-manager.js"></script>

    <!-- AI Modules -->
    <script src="js/ai/job-parser.js"></script>
    <script src="js/ai/mapper.js"></script>
    <script src="js/ai/tailor.js"></script>

    <!-- UI Components -->
    <script src="js/ui/getting-started-modal.js"></script>
    <script src="js/ui/job-indicator.js"></script>
    <script src="js/ui/resume-preview.js"></script>

    <!-- Workflow Scripts -->
    <script src="js/ui/workflow-ui.js"></script>
    <script src="js/workflow/workflow-integration.js"></script>

    <script>
        // Global references
        let workflowUI = null;
        let workflowIntegration = null;
        let gettingStartedModal = null;
        let jobIndicator = null;
        let resumePreview = null;

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme immediately
        initTheme();

        // Initialize workflow system
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[Workflow] Initializing...');

            // Initialize WorkflowUI
            if (typeof WorkflowUI !== 'undefined') {
                workflowUI = new WorkflowUI();
                window.workflowUI = workflowUI;

                // Override event handlers with backend integration
                setupBackendIntegration();

                workflowUI.initialize();
                console.log('[Workflow] UI initialized');
            }

            // Initialize WorkflowIntegration
            if (typeof WorkflowIntegration !== 'undefined' && workflowUI) {
                workflowIntegration = new WorkflowIntegration(workflowUI);
                window.workflowIntegration = workflowIntegration;
                await workflowIntegration.initialize();
                console.log('[Workflow] Integration initialized');
            }

            // Initialize export system
            if (typeof ExportManager !== 'undefined') {
                window.exportManager = new ExportManager();
                await window.exportManager.initialize();
                console.log('[Workflow] Export system initialized');
            }

            // Initialize Getting Started Modal
            if (typeof GettingStartedModal !== 'undefined') {
                gettingStartedModal = new GettingStartedModal();
                window.gettingStartedModal = gettingStartedModal;
                gettingStartedModal.initialize();
                console.log('[Workflow] Getting Started modal initialized');
            }

            // Initialize Job Indicator
            if (typeof JobIndicator !== 'undefined') {
                jobIndicator = new JobIndicator();
                window.jobIndicator = jobIndicator;
                jobIndicator.initialize();
                console.log('[Workflow] Job indicator initialized');
            }

            // Initialize Resume Preview (if preview container exists)
            const previewContainer = document.getElementById('resume-preview');
            if (previewContainer && typeof ResumePreview !== 'undefined') {
                resumePreview = new ResumePreview('resume-preview');
                window.resumePreview = resumePreview;
                resumePreview.initialize();
                console.log('[Workflow] Resume preview initialized');
            }
        });

        // Setup backend integration for all workflow steps
        function setupBackendIntegration() {
            // Step 1: Resume upload
            const resumeFile = document.getElementById('resume-file');
            if (resumeFile) {
                resumeFile.addEventListener('change', async (e) => {
                    if (e.target.files[0] && workflowIntegration) {
                        try {
                            await workflowIntegration.handleResumeUpload(e.target.files[0]);
                        } catch (error) {
                            console.error('[Workflow] Resume upload error:', error);
                        }
                    }
                });
            }

            const resumeText = document.getElementById('resume-text');
            if (resumeText) {
                resumeText.addEventListener('input', (e) => {
                    if (workflowIntegration) {
                        workflowIntegration.handleResumeTextPaste(e.target.value);
                    }
                    checkStep1Complete();
                });
            }

            // Job description handlers (Step 1)
            const jobUrlInput = document.getElementById('job-url');
            const importJobBtn = document.getElementById('import-job-btn');

            if (importJobBtn && jobUrlInput) {
                importJobBtn.addEventListener('click', async () => {
                    const url = jobUrlInput.value.trim();
                    if (url && workflowIntegration) {
                        try {
                            await workflowIntegration.fetchJobFromURL(url);
                            checkStep1Complete();
                        } catch (error) {
                            console.error('[Workflow] Job fetch error:', error);
                        }
                    }
                });
            }

            const jobText = document.getElementById('job-text');
            if (jobText) {
                jobText.addEventListener('input', (e) => {
                    if (workflowIntegration) {
                        workflowIntegration.handleJobTextPaste(e.target.value);
                    }
                    checkStep1Complete();
                });
            }

            // Enable Continue button when both resume and job description are present
            function checkStep1Complete() {
                const hasResume = (resumeFile && resumeFile.files.length > 0) ||
                                (resumeText && resumeText.value.trim().length > 50);
                const hasJob = (jobText && jobText.value.trim().length > 50) ||
                             (jobUrlInput && jobUrlInput.value.trim().length > 10);

                const continueBtn = document.getElementById('step-1-continue');
                if (continueBtn) {
                    continueBtn.disabled = !(hasResume && hasJob);
                    console.log('[Workflow] Step 1 validation:', { hasResume, hasJob, enabled: hasResume && hasJob });
                }
            }

            // Check on file upload
            if (resumeFile) {
                resumeFile.addEventListener('change', () => {
                    setTimeout(checkStep1Complete, 500); // Wait for processing
                });
            }

            // Step 1 Continue button click handler
            const step1ContinueBtn = document.getElementById('step-1-continue');
            if (step1ContinueBtn) {
                step1ContinueBtn.addEventListener('click', async () => {
                    console.log('[Workflow] Step 1 Continue clicked');

                    // Show step 2 (analysis)
                    const step1 = document.getElementById('step-upload');
                    const step2 = document.getElementById('step-analyze');

                    if (step1 && step2) {
                        step1.classList.remove('active');
                        step1.classList.add('locked');
                        step1.setAttribute('aria-hidden', 'true');

                        step2.classList.remove('locked');
                        step2.classList.add('active');
                        step2.removeAttribute('aria-hidden');

                        // Update progress dots
                        const dot1 = document.querySelector('[data-step="1"]');
                        const dot2 = document.querySelector('[data-step="2"]');
                        if (dot1) {
                            dot1.classList.remove('active');
                            dot1.classList.add('completed');
                        }
                        if (dot2) {
                            dot2.classList.remove('locked');
                            dot2.classList.add('active');
                            dot2.setAttribute('aria-current', 'step');
                        }

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });

                        // Start analysis if integration is available
                        if (workflowIntegration) {
                            try {
                                console.log('[Workflow] Starting analysis...');
                                await workflowIntegration.analyzeResume();
                            } catch (error) {
                                console.error('[Workflow] Analysis error:', error);
                                alert('Analysis failed: ' + error.message);
                            }
                        }
                    }
                });
            }

            // Step 2 Continue button click handler
            const step2ContinueBtn = document.getElementById('step-2-continue');
            if (step2ContinueBtn) {
                step2ContinueBtn.addEventListener('click', () => {
                    console.log('[Workflow] Step 2 Continue clicked');

                    const step2 = document.getElementById('step-analyze');
                    const step3 = document.getElementById('step-tailor');

                    if (step2 && step3) {
                        step2.classList.remove('active');
                        step2.classList.add('locked');
                        step2.setAttribute('aria-hidden', 'true');

                        step3.classList.remove('locked');
                        step3.classList.add('active');
                        step3.removeAttribute('aria-hidden');

                        // Update progress dots
                        const dot2 = document.querySelector('[data-step="2"]');
                        const dot3 = document.querySelector('[data-step="3"]');
                        if (dot2) {
                            dot2.classList.remove('active');
                            dot2.classList.add('completed');
                        }
                        if (dot3) {
                            dot3.classList.remove('locked');
                            dot3.classList.add('active');
                            dot3.setAttribute('aria-current', 'step');
                        }

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
            }

            // Step 2: Analysis
            // Override the startAnalysis method
            if (workflowUI) {
                const originalStartAnalysis = workflowUI.startAnalysis.bind(workflowUI);
                workflowUI.startAnalysis = async function() {
                    console.log('[Workflow] Starting analysis with backend integration...');
                    this.goToNextStep();

                    if (workflowIntegration) {
                        try {
                            await workflowIntegration.analyzeResume();
                        } catch (error) {
                            console.error('[Workflow] Analysis error:', error);
                        }
                    }
                };
            }

            // Step 3: Job tailoring (job input now in Step 1)
            // Override the startTailoring method
            if (workflowUI) {
                const originalStartTailoring = workflowUI.startTailoring.bind(workflowUI);
                workflowUI.startTailoring = async function() {
                    console.log('[Workflow] Starting tailoring with backend integration...');

                    if (workflowIntegration) {
                        try {
                            await workflowIntegration.tailorResume();
                            this.goToNextStep();
                        } catch (error) {
                            console.error('[Workflow] Tailoring error:', error);
                        }
                    }
                };
            }

            // Step 5: Export
            const exportButtons = document.querySelectorAll('.btn-export');
            exportButtons.forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const format = btn.dataset.format;
                    if (workflowIntegration) {
                        try {
                            await workflowIntegration.exportDocument(format);
                        } catch (error) {
                            console.error('[Workflow] Export error:', error);
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
