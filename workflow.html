<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResuMate - Resume Builder Workflow</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/workflow.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#workflow-main" class="skip-to-main">Skip to main content</a>

    <!-- Navigation Bar -->
    <nav class="resumate-navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">
                <span class="navbar-logo">üìÑ</span>
                <span class="navbar-title">ResuMate</span>
            </a>

            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="workflow.html" class="nav-link active">
                        <span class="nav-link-icon">‚ú®</span>
                        Resume Builder
                    </a>
                </li>
            </ul>

            <div class="navbar-actions">
                <button class="nav-theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span class="theme-icon-sun">‚òÄÔ∏è</span>
                    <span class="theme-icon-moon">üåô</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Workflow Container -->
    <main id="workflow-main" class="workflow-container" tabindex="-1">
        <!-- Progress Indicator -->
        <div class="workflow-progress" role="navigation" aria-label="Workflow progress">
            <div class="progress-dots">
                <button
                    class="progress-dot active"
                    data-step="1"
                    aria-label="Step 1: Upload Resume"
                    aria-current="step"
                    disabled>
                    <span class="progress-number">1</span>
                    <span class="progress-label">Upload</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="2"
                    aria-label="Step 2: Analysis (locked)"
                    disabled>
                    <span class="progress-number">2</span>
                    <span class="progress-label">Analyze</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="3"
                    aria-label="Step 3: Job Tailoring (locked)"
                    disabled>
                    <span class="progress-number">3</span>
                    <span class="progress-label">Tailor</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="4"
                    aria-label="Step 4: Edit Resume (locked)"
                    disabled>
                    <span class="progress-number">4</span>
                    <span class="progress-label">Edit</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="5"
                    aria-label="Step 5: Export (locked)"
                    disabled>
                    <span class="progress-number">5</span>
                    <span class="progress-label">Export</span>
                </button>
                <div class="progress-connector"></div>

                <button
                    class="progress-dot locked"
                    data-step="6"
                    aria-label="Step 6: Additional Documents (locked)"
                    disabled>
                    <span class="progress-number">6</span>
                    <span class="progress-label">More</span>
                </button>
            </div>
        </div>

        <!-- Workflow Steps Container -->
        <div class="workflow-steps">
            <!-- Step 1: Upload Resume -->
            <section id="step-upload" class="workflow-step active" aria-labelledby="step-upload-title">
                <div class="step-header">
                    <h1 id="step-upload-title" class="step-title">
                        <span class="step-icon">üìÑ</span>
                        Upload Resume & Job Description
                    </h1>
                    <p class="step-description">
                        Start by uploading your resume and adding the job description you're applying for.
                    </p>
                </div>

                <div class="step-content">
                    <!-- Resume Input -->
                    <div class="card">
                        <h2 style="margin-bottom: 1rem;">üìÑ Your Resume</h2>
                        <div class="input-group">
                            <label for="resume-file" class="file-upload-label">
                                <span class="upload-icon">üìé</span>
                                Upload Resume (PDF, DOC, DOCX, TXT)
                                <input type="file" id="resume-file" accept=".pdf,.doc,.docx,.txt">
                            </label>

                            <div class="divider">OR</div>

                            <label for="resume-text" class="sr-only">Paste your resume text</label>
                            <textarea
                                id="resume-text"
                                placeholder="Paste your resume text here..."
                                rows="10"
                                aria-describedby="resume-help"></textarea>
                            <small id="resume-help" class="help-text">
                                Your resume data is processed securely and never stored permanently.
                            </small>
                        </div>
                    </div>

                    <!-- Job Description Input -->
                    <div class="card" style="margin-top: 2rem;">
                        <h2 style="margin-bottom: 1rem;">üíº Job Description</h2>
                        <div class="input-group">
                            <div class="job-url-import">
                                <label for="job-url">
                                    üîó Import from URL (LinkedIn, Indeed, etc.)
                                </label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input
                                        type="url"
                                        id="job-url"
                                        placeholder="https://linkedin.com/jobs/view/..."
                                        style="flex: 1; padding: 0.875rem; font-size: 1rem;">
                                    <button type="button" id="import-job-btn" class="btn-secondary" style="min-width: 100px;">
                                        Import
                                    </button>
                                </div>
                                <small id="job-url-status" style="margin-top: 0.5rem; display: block;"></small>
                            </div>

                            <div class="divider">OR</div>

                            <label for="job-text" class="sr-only">Paste job description</label>
                            <textarea
                                id="job-text"
                                placeholder="Paste the job description here..."
                                rows="8"
                                aria-describedby="job-help"></textarea>
                            <small id="job-help" class="help-text">
                                Include the full job description for best resume analysis results.
                            </small>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        id="step-1-continue"
                        class="btn-primary btn-continue"
                        disabled
                        aria-label="Continue to analysis step">
                        Continue to Analysis
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 2: Analysis -->
            <section id="step-analyze" class="workflow-step locked" aria-labelledby="step-analyze-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-analyze-title" class="step-title">
                        <span class="step-icon">üîç</span>
                        Resume Analysis
                    </h1>
                    <p class="step-description">
                        We'll analyze your resume for ATS compatibility, keyword optimization, and overall quality.
                    </p>
                </div>

                <div class="step-content">
                    <!-- Loading State -->
                    <div id="analyze-loading" class="loading-state" style="display: none;">
                        <p>‚ú® AI is working its magic...</p>
                    </div>

                    <!-- Analysis Results (populated by JS) -->
                    <div id="analyze-results" class="analysis-results" style="display: none;">
                        <!-- Results will be inserted here by workflow-ui.js -->
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to upload step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-2-continue"
                        class="btn-primary btn-continue"
                        disabled
                        aria-label="Continue to job tailoring step">
                        Continue to Tailoring
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 3: Job Tailoring -->
            <section id="step-tailor" class="workflow-step locked" aria-labelledby="step-tailor-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-tailor-title" class="step-title">
                        <span class="step-icon">üéØ</span>
                        Tailor Your Resume
                    </h1>
                    <p class="step-description">
                        AI will optimize your resume to match the job description and maximize your chances.
                    </p>
                </div>

                <div class="step-content">
                    <!-- Job Summary Card -->
                    <div class="card" style="background: var(--bg-color); border-left: 4px solid var(--primary-color);">
                        <h3 style="margin-bottom: 0.75rem; color: var(--text-color);">üìã Targeting This Position:</h3>
                        <div id="job-summary" style="color: var(--text-color); padding: 1rem; background: var(--card-bg); border-radius: 8px; max-height: 120px; overflow-y: auto;">
                            <p style="margin: 0; color: var(--text-muted);">Loading job description...</p>
                        </div>
                    </div>

                    <!-- Tailoring Options Card -->
                    <div class="card" style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--text-color);">‚öôÔ∏è Tailoring Options</h3>
                        <div class="tailor-options" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-color); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="tailor-keywords" checked style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="color: var(--text-color); font-size: 1rem;">
                                    <strong>Optimize keywords for ATS</strong><br>
                                    <small style="color: var(--text-muted);">Match job requirements with relevant keywords</small>
                                </span>
                            </label>
                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-color); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="tailor-skills" checked style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="color: var(--text-color); font-size: 1rem;">
                                    <strong>Match required skills</strong><br>
                                    <small style="color: var(--text-muted);">Highlight skills mentioned in the job posting</small>
                                </span>
                            </label>
                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-color); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="tailor-experience" checked style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="color: var(--text-color); font-size: 1rem;">
                                    <strong>Emphasize relevant experience</strong><br>
                                    <small style="color: var(--text-muted);">Prioritize experience that matches the role</small>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="tailor-loading" class="loading-state" style="display: none; text-align: center; padding: 2rem;">
                        <div class="spinner" style="margin: 0 auto 1rem;"></div>
                        <p style="color: var(--text-color);">‚ú® Tailoring your resume...</p>
                    </div>

                    <!-- Tailoring Results -->
                    <div id="tailor-results" class="card" style="display: none; margin-top: 2rem; background: var(--card-bg);">
                        <h3 style="color: var(--text-color); margin-bottom: 1rem;">üí° Tailoring Suggestions</h3>
                        <div id="tailor-suggestions-content" style="color: var(--text-color);">
                            <!-- Results will be inserted here -->
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to analysis step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-3-skip"
                        class="btn-secondary"
                        style="padding: 1rem 2rem; font-size: 1rem;"
                        aria-label="Skip job tailoring">
                        Skip This Step
                    </button>
                    <button
                        id="step-3-continue"
                        class="btn-primary btn-continue"
                        disabled
                        aria-label="Continue to edit resume step">
                        Tailor Resume
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 4: Edit Resume -->
            <section id="step-edit" class="workflow-step locked" aria-labelledby="step-edit-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-edit-title" class="step-title">
                        <span class="step-icon">‚úèÔ∏è</span>
                        Edit & Preview
                    </h1>
                    <p class="step-description">
                        Make final edits to your resume and preview how it looks.
                    </p>
                </div>

                <div class="step-content">
                    <div class="editor-container">
                        <!-- Split view: editor on left, preview on right -->
                        <div class="editor-panel">
                            <div class="editor-toolbar">
                                <button class="toolbar-btn" title="Bold">
                                    <strong>B</strong>
                                </button>
                                <button class="toolbar-btn" title="Italic">
                                    <em>I</em>
                                </button>
                                <button class="toolbar-btn" title="Bullet List">
                                    ‚Ä¢
                                </button>
                            </div>
                            <div id="resume-editor" contenteditable="true" class="resume-editor" role="textbox" aria-label="Resume editor">
                                <!-- Editable resume content -->
                            </div>
                        </div>

                        <div class="preview-panel">
                            <div class="preview-toolbar">
                                <select id="template-select" aria-label="Select resume template">
                                    <option value="classic">Classic</option>
                                    <option value="modern">Modern</option>
                                    <option value="creative">Creative</option>
                                </select>
                            </div>
                            <div id="resume-preview" class="resume-preview">
                                <!-- Live preview -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to tailoring step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-4-continue"
                        class="btn-primary btn-continue"
                        aria-label="Continue to export step">
                        Continue to Export
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 5: Export -->
            <section id="step-export" class="workflow-step locked" aria-labelledby="step-export-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-export-title" class="step-title">
                        <span class="step-icon">üì•</span>
                        Export Your Resume
                    </h1>
                    <p class="step-description">
                        Download your optimized resume in your preferred format.
                    </p>
                </div>

                <div class="step-content">
                    <div class="export-options">
                        <div class="export-card" data-format="pdf">
                            <div class="export-icon">üìÑ</div>
                            <h3>PDF Document</h3>
                            <p>Best for job applications</p>
                            <button class="btn-export" data-format="pdf">
                                Download PDF
                            </button>
                        </div>

                        <div class="export-card" data-format="docx">
                            <div class="export-icon">üìù</div>
                            <h3>Word Document</h3>
                            <p>Editable format</p>
                            <button class="btn-export" data-format="docx">
                                Download DOCX
                            </button>
                        </div>

                        <div class="export-card" data-format="txt">
                            <div class="export-icon">üìã</div>
                            <h3>Plain Text</h3>
                            <p>ATS-friendly format</p>
                            <button class="btn-export" data-format="txt">
                                Download TXT
                            </button>
                        </div>
                    </div>

                    <div class="export-success" id="export-success" style="display: none;">
                        <div class="success-icon">‚úÖ</div>
                        <h2>Resume Ready!</h2>
                        <p>Your optimized resume has been downloaded successfully.</p>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to edit step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-5-continue"
                        class="btn-primary btn-continue"
                        aria-label="Continue to additional documents">
                        Continue
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Step 6: Additional Documents -->
            <section id="step-additional" class="workflow-step locked" aria-labelledby="step-additional-title" aria-hidden="true">
                <div class="step-header">
                    <h1 id="step-additional-title" class="step-title">
                        <span class="step-icon">üìù</span>
                        Additional Career Documents
                    </h1>
                    <p class="step-description">
                        Generate complementary documents to strengthen your job application.
                    </p>
                </div>

                <div class="step-content">
                    <!-- Document Generators (2x2 Grid) -->
                    <h2 style="color: var(--text-color); margin-bottom: 1.5rem; font-size: 1.25rem;">üìÑ Document Generators</h2>
                    <div class="document-options" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 3rem;">
                        <!-- Cover Letter -->
                        <div class="document-card" style="background: var(--card-bg); padding: 1.75rem; border-radius: 12px; border: 2px solid var(--border-color); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='var(--border-color)'">
                            <div class="document-icon" style="font-size: 2.5rem; margin-bottom: 0.75rem;">‚úâÔ∏è</div>
                            <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-size: 1.125rem;">Cover Letter</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.25rem; line-height: 1.5; font-size: 0.9rem;">
                                Tailored letter highlighting relevant experience for this specific job.
                            </p>
                            <button class="btn-primary" id="generate-cover-letter" style="width: 100%;">
                                Generate
                            </button>
                        </div>

                        <!-- Executive Brand Statement -->
                        <div class="document-card" style="background: var(--card-bg); padding: 1.75rem; border-radius: 12px; border: 2px solid var(--border-color); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='var(--border-color)'">
                            <div class="document-icon" style="font-size: 2.5rem; margin-bottom: 0.75rem;">üíº</div>
                            <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-size: 1.125rem;">Executive Brand Statement</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.25rem; line-height: 1.5; font-size: 0.9rem;">
                                First-person statement (2-3 paragraphs) for LinkedIn About section.
                            </p>
                            <button class="btn-primary" id="generate-brand-statement" style="width: 100%;">
                                Generate
                            </button>
                        </div>

                        <!-- Executive Bio -->
                        <div class="document-card" style="background: var(--card-bg); padding: 1.75rem; border-radius: 12px; border: 2px solid var(--border-color); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='var(--border-color)'">
                            <div class="document-icon" style="font-size: 2.5rem; margin-bottom: 0.75rem;">üìù</div>
                            <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-size: 1.125rem;">Executive Bio</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.25rem; line-height: 1.5; font-size: 0.9rem;">
                                Third-person bio (150-200 words) for conferences and press releases.
                            </p>
                            <button class="btn-primary" id="generate-executive-bio" style="width: 100%;">
                                Generate
                            </button>
                        </div>

                        <!-- Status Inquiry Letter -->
                        <div class="document-card" style="background: var(--card-bg); padding: 1.75rem; border-radius: 12px; border: 2px solid var(--border-color); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='var(--border-color)'">
                            <div class="document-icon" style="font-size: 2.5rem; margin-bottom: 0.75rem;">üì¨</div>
                            <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-size: 1.125rem;">Status Inquiry Letter</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.25rem; line-height: 1.5; font-size: 0.9rem;">
                                Professional follow-up letter to check on your application status.
                            </p>
                            <button class="btn-primary" id="generate-followup-letter" style="width: 100%;">
                                Generate
                            </button>
                        </div>
                    </div>

                    <!-- LinkedIn Profile Review Section -->
                    <div class="linkedin-section" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%); padding: 2rem; border-radius: 12px; border: 2px solid var(--primary-color); margin-bottom: 2rem;">
                        <h2 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            üîó LinkedIn Profile Review & Optimizer
                        </h2>
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.6;">
                            Submit your LinkedIn profile URL or paste your profile content for AI-powered optimization suggestions.
                        </p>

                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <input
                                type="url"
                                id="linkedin-url"
                                placeholder="https://linkedin.com/in/yourprofile"
                                style="flex: 1; padding: 0.875rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; color: var(--text-color); background: var(--card-bg);">
                            <button class="btn-primary" id="fetch-linkedin-profile" style="min-width: 120px;">
                                Fetch Profile
                            </button>
                        </div>

                        <div class="divider" style="text-align: center; color: var(--text-muted); font-weight: 500; position: relative; margin: 1.5rem 0;">
                            <span style="background: var(--card-bg); padding: 0 1rem; position: relative; z-index: 1;">OR</span>
                            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--border-color);"></div>
                        </div>

                        <textarea
                            id="linkedin-content"
                            placeholder="Paste your LinkedIn profile content here (headline, about section, experience descriptions)..."
                            rows="6"
                            style="width: 100%; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; font-size: 0.95rem; resize: vertical; color: var(--text-color); background: var(--card-bg); margin-bottom: 1rem;"></textarea>

                        <button class="btn-primary" id="analyze-linkedin-profile" style="width: 100%;">
                            üîç Analyze & Optimize Profile
                        </button>
                    </div>

                    <!-- Generated content will appear here -->
                    <div id="generated-content" class="card" style="display: none; margin-top: 2rem; background: var(--card-bg);">
                        <h3 style="color: var(--text-color); margin-bottom: 1rem;">Generated Document</h3>
                        <div id="generated-text" style="color: var(--text-color); white-space: pre-wrap; line-height: 1.8; padding: 1.5rem; background: var(--bg-color); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                            <!-- Content will be inserted here -->
                        </div>
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                            <button class="btn-primary" id="copy-generated">
                                üìã Copy to Clipboard
                            </button>
                            <button class="btn-secondary" id="download-generated">
                                üì• Download
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="additional-loading" class="loading-state" style="display: none; text-align: center; padding: 3rem;">
                        <p style="color: var(--text-color); font-size: 1.125rem;">‚ú® AI is crafting your document...</p>
                    </div>
                </div>

                <div class="step-actions">
                    <button
                        class="btn-secondary btn-back"
                        aria-label="Go back to export step">
                        <span class="btn-icon">‚Üê</span>
                        Back
                    </button>
                    <button
                        id="step-6-finish"
                        class="btn-primary"
                        aria-label="Finish and start new">
                        Finish & Start New
                    </button>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <p>Built with ‚ù§Ô∏è using Claude AI | <a href="https://github.com/ry-ops/ResuMate" target="_blank">GitHub</a></p>
    </footer>

    <!-- Core Dependencies -->
    <script src="js/core/data-bridge.js"></script>

    <!-- Export Libraries (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Export Modules -->
    <script src="js/export/pdf-export.js"></script>
    <script src="js/export/docx-export.js"></script>
    <script src="js/export/formats.js"></script>
    <script src="js/export/export-manager.js"></script>

    <!-- AI Modules -->
    <script src="js/ai/job-parser.js"></script>
    <script src="js/ai/mapper.js"></script>
    <script src="js/ai/tailor.js"></script>

    <!-- UI Components -->
    <script src="js/ui/getting-started-modal.js"></script>
    <script src="js/ui/job-indicator.js"></script>
    <script src="js/ui/resume-preview.js"></script>

    <!-- Workflow Scripts -->
    <script src="js/ui/workflow-ui.js"></script>
    <script src="js/workflow/workflow-integration.js"></script>

    <script>
        // Global references
        let workflowUI = null;
        let workflowIntegration = null;
        let gettingStartedModal = null;
        let jobIndicator = null;
        let resumePreview = null;

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme immediately
        initTheme();

        // Initialize workflow system
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[Workflow] Initializing...');

            // Initialize WorkflowUI
            if (typeof WorkflowUI !== 'undefined') {
                workflowUI = new WorkflowUI();
                window.workflowUI = workflowUI;
                workflowUI.initialize();
                console.log('[Workflow] UI initialized');
            }

            // Initialize WorkflowIntegration
            if (typeof WorkflowIntegration !== 'undefined' && workflowUI) {
                workflowIntegration = new WorkflowIntegration(workflowUI);
                window.workflowIntegration = workflowIntegration;
                await workflowIntegration.initialize();
                console.log('[Workflow] Integration initialized');

                // Setup backend integration AFTER WorkflowIntegration is initialized
                setupBackendIntegration();
            }

            // Initialize export system
            if (typeof ExportManager !== 'undefined') {
                window.exportManager = new ExportManager();
                await window.exportManager.initialize();
                console.log('[Workflow] Export system initialized');
            }

            // Initialize Getting Started Modal
            if (typeof GettingStartedModal !== 'undefined') {
                gettingStartedModal = new GettingStartedModal();
                window.gettingStartedModal = gettingStartedModal;
                gettingStartedModal.initialize();
                console.log('[Workflow] Getting Started modal initialized');
            }

            // Initialize Job Indicator
            if (typeof JobIndicator !== 'undefined') {
                jobIndicator = new JobIndicator();
                window.jobIndicator = jobIndicator;
                jobIndicator.initialize();
                console.log('[Workflow] Job indicator initialized');
            }

            // Initialize Resume Preview (if preview container exists)
            const previewContainer = document.getElementById('resume-preview');
            if (previewContainer && typeof ResumePreview !== 'undefined') {
                resumePreview = new ResumePreview('resume-preview');
                window.resumePreview = resumePreview;
                resumePreview.initialize();
                console.log('[Workflow] Resume preview initialized');
            }
        });

        // Setup backend integration for all workflow steps
        function setupBackendIntegration() {
            // Step 1: Resume upload
            const resumeFile = document.getElementById('resume-file');
            if (resumeFile) {
                console.log('[Workflow] Attaching resume file upload listener');
                resumeFile.addEventListener('change', async (e) => {
                    console.log('[Workflow] Resume file selected');
                    console.log('[Workflow] File:', e.target.files[0]?.name);
                    console.log('[Workflow] workflowIntegration exists:', !!workflowIntegration);

                    if (!e.target.files[0]) {
                        console.warn('[Workflow] No file selected');
                        return;
                    }

                    if (!workflowIntegration) {
                        console.error('[Workflow] workflowIntegration not initialized!');
                        alert('System not initialized. Please reload the page.');
                        return;
                    }

                    try {
                        await workflowIntegration.handleResumeUpload(e.target.files[0]);
                    } catch (error) {
                        console.error('[Workflow] Resume upload error:', error);
                        alert('Failed to upload resume: ' + error.message);
                    }
                });
                console.log('[Workflow] Resume file upload listener attached');
            } else {
                console.warn('[Workflow] Resume file input not found!');
            }

            const resumeText = document.getElementById('resume-text');
            if (resumeText) {
                resumeText.addEventListener('input', (e) => {
                    if (workflowIntegration) {
                        workflowIntegration.handleResumeTextPaste(e.target.value);
                    }
                    checkStep1Complete();
                });
            }

            // Job description handlers (Step 1)
            const jobUrlInput = document.getElementById('job-url');
            const importJobBtn = document.getElementById('import-job-btn');

            if (importJobBtn && jobUrlInput) {
                console.log('[Workflow] Attaching job import button listener');
                importJobBtn.addEventListener('click', async () => {
                    console.log('[Workflow] Import button clicked');
                    const url = jobUrlInput.value.trim();
                    console.log('[Workflow] URL:', url);
                    console.log('[Workflow] workflowIntegration exists:', !!workflowIntegration);

                    if (!url) {
                        alert('Please enter a job URL');
                        return;
                    }

                    if (!workflowIntegration) {
                        console.error('[Workflow] workflowIntegration not initialized!');
                        alert('System not initialized. Please reload the page.');
                        return;
                    }

                    try {
                        await workflowIntegration.fetchJobFromURL(url);
                        checkStep1Complete();
                    } catch (error) {
                        console.error('[Workflow] Job fetch error:', error);
                        alert('Failed to fetch job: ' + error.message);
                    }
                });
                console.log('[Workflow] Job import button listener attached');
            } else {
                console.warn('[Workflow] Import button or URL input not found!', { importJobBtn: !!importJobBtn, jobUrlInput: !!jobUrlInput });
            }

            const jobText = document.getElementById('job-text');
            if (jobText) {
                jobText.addEventListener('input', (e) => {
                    if (workflowIntegration) {
                        workflowIntegration.handleJobTextPaste(e.target.value);
                    }
                    checkStep1Complete();
                });
            }

            // Enable Continue button when both resume and job description are present
            function checkStep1Complete() {
                const hasResume = (resumeFile && resumeFile.files.length > 0) ||
                                (resumeText && resumeText.value.trim().length > 50);
                const hasJob = (jobText && jobText.value.trim().length > 50) ||
                             (jobUrlInput && jobUrlInput.value.trim().length > 10);

                const continueBtn = document.getElementById('step-1-continue');
                if (continueBtn) {
                    continueBtn.disabled = !(hasResume && hasJob);
                    console.log('[Workflow] Step 1 validation:', { hasResume, hasJob, enabled: hasResume && hasJob });
                }
            }

            // Check on file upload
            if (resumeFile) {
                resumeFile.addEventListener('change', () => {
                    setTimeout(checkStep1Complete, 500); // Wait for processing
                });
            }

            // Step 1 Continue button click handler
            const step1ContinueBtn = document.getElementById('step-1-continue');
            if (step1ContinueBtn) {
                step1ContinueBtn.addEventListener('click', async () => {
                    console.log('[Workflow] Step 1 Continue clicked');

                    // Show step 2 (analysis)
                    const step1 = document.getElementById('step-upload');
                    const step2 = document.getElementById('step-analyze');

                    if (step1 && step2) {
                        step1.classList.remove('active');
                        step1.classList.add('locked');
                        step1.setAttribute('aria-hidden', 'true');

                        step2.classList.remove('locked');
                        step2.classList.add('active');
                        step2.removeAttribute('aria-hidden');

                        // Update progress dots
                        const dot1 = document.querySelector('[data-step="1"]');
                        const dot2 = document.querySelector('[data-step="2"]');
                        if (dot1) {
                            dot1.classList.remove('active');
                            dot1.classList.add('completed');
                        }
                        if (dot2) {
                            dot2.classList.remove('locked');
                            dot2.classList.add('active');
                            dot2.setAttribute('aria-current', 'step');
                        }

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });

                        // Start analysis if integration is available
                        if (workflowIntegration) {
                            try {
                                console.log('[Workflow] Starting analysis...');
                                await workflowIntegration.analyzeResume();
                            } catch (error) {
                                console.error('[Workflow] Analysis error:', error);
                                alert('Analysis failed: ' + error.message);
                            }
                        }
                    }
                });
            }

            // Step 2 Continue button click handler
            const step2ContinueBtn = document.getElementById('step-2-continue');
            if (step2ContinueBtn) {
                step2ContinueBtn.addEventListener('click', () => {
                    console.log('[Workflow] Step 2 Continue clicked');

                    const step2 = document.getElementById('step-analyze');
                    const step3 = document.getElementById('step-tailor');

                    if (step2 && step3) {
                        step2.classList.remove('active');
                        step2.classList.add('locked');
                        step2.setAttribute('aria-hidden', 'true');

                        step3.classList.remove('locked');
                        step3.classList.add('active');
                        step3.removeAttribute('aria-hidden');

                        // Update progress dots
                        const dot2 = document.querySelector('[data-step="2"]');
                        const dot3 = document.querySelector('[data-step="3"]');
                        if (dot2) {
                            dot2.classList.remove('active');
                            dot2.classList.add('completed');
                        }
                        if (dot3) {
                            dot3.classList.remove('locked');
                            dot3.classList.add('active');
                            dot3.setAttribute('aria-current', 'step');
                        }

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });

                        // Load job description into Step 3 summary
                        loadJobSummaryIntoStep3();

                        // Enable Tailor Resume button
                        const step3ContinueBtn = document.getElementById('step-3-continue');
                        if (step3ContinueBtn) {
                            step3ContinueBtn.disabled = false;
                        }
                    }
                });
            }

            // Step 3: Load job description from Step 1
            function loadJobSummaryIntoStep3() {
                const jobSummaryDiv = document.getElementById('job-summary');
                if (!jobSummaryDiv) return;

                // Get job description from Step 1
                const jobText = document.getElementById('job-text');
                const jobUrlInput = document.getElementById('job-url');

                let jobDescription = '';

                // Priority: job text, then URL
                if (jobText && jobText.value.trim().length > 0) {
                    jobDescription = jobText.value.trim();
                } else if (workflowIntegration && workflowIntegration.jobDescription) {
                    // If job was fetched from URL
                    jobDescription = workflowIntegration.jobDescription;
                }

                // Display job summary
                if (jobDescription && jobDescription.length > 0) {
                    // Show first 300 characters with ellipsis
                    const summary = jobDescription.length > 300
                        ? jobDescription.substring(0, 300) + '...'
                        : jobDescription;

                    jobSummaryDiv.innerHTML = `
                        <p style="margin: 0; color: var(--text-color); white-space: pre-wrap; line-height: 1.5;">
                            ${summary}
                        </p>
                    `;
                    console.log('[Workflow] Job summary loaded into Step 3');
                } else {
                    jobSummaryDiv.innerHTML = `
                        <p style="margin: 0; color: var(--text-muted);">No job description provided.</p>
                    `;
                    console.warn('[Workflow] No job description found for Step 3');
                }
            }

            // Step 3 Continue button (Tailor Resume)
            const step3ContinueBtn = document.getElementById('step-3-continue');
            if (step3ContinueBtn) {
                step3ContinueBtn.addEventListener('click', async () => {
                    console.log('[Workflow] Step 3 Continue (Tailor Resume) clicked');

                    // Show loading state
                    const loadingDiv = document.getElementById('tailor-loading');
                    const resultsDiv = document.getElementById('tailor-results');

                    if (loadingDiv) loadingDiv.style.display = 'block';
                    if (resultsDiv) resultsDiv.style.display = 'none';

                    // Start tailoring if integration is available
                    if (workflowIntegration) {
                        try {
                            console.log('[Workflow] Starting tailoring...');
                            await workflowIntegration.tailorResume();

                            // Hide loading, show results
                            if (loadingDiv) loadingDiv.style.display = 'none';
                            if (resultsDiv) resultsDiv.style.display = 'block';

                            // Transition to Step 4 after a brief delay
                            setTimeout(() => {
                                const step3 = document.getElementById('step-tailor');
                                const step4 = document.getElementById('step-edit');

                                if (step3 && step4) {
                                    step3.classList.remove('active');
                                    step3.classList.add('locked');
                                    step3.setAttribute('aria-hidden', 'true');

                                    step4.classList.remove('locked');
                                    step4.classList.add('active');
                                    step4.removeAttribute('aria-hidden');

                                    // Update progress dots
                                    const dot3 = document.querySelector('[data-step="3"]');
                                    const dot4 = document.querySelector('[data-step="4"]');
                                    if (dot3) {
                                        dot3.classList.remove('active');
                                        dot3.classList.add('completed');
                                    }
                                    if (dot4) {
                                        dot4.classList.remove('locked');
                                        dot4.classList.add('active');
                                        dot4.setAttribute('aria-current', 'step');
                                    }

                                    // Scroll to top
                                    window.scrollTo({ top: 0, behavior: 'smooth' });

                                    // Populate Step 4 editor and preview
                                    populateStep4EditorAndPreview();
                                }
                            }, 1500);
                        } catch (error) {
                            console.error('[Workflow] Tailoring error:', error);
                            alert('Tailoring failed: ' + error.message);

                            // Hide loading on error
                            if (loadingDiv) loadingDiv.style.display = 'none';
                        }
                    } else {
                        console.warn('[Workflow] WorkflowIntegration not available');
                        alert('Tailoring system not initialized');
                        if (loadingDiv) loadingDiv.style.display = 'none';
                    }
                });
            }

            // Step 3 Skip button
            const step3SkipBtn = document.getElementById('step-3-skip');
            if (step3SkipBtn) {
                step3SkipBtn.addEventListener('click', () => {
                    console.log('[Workflow] Step 3 Skip clicked');

                    const step3 = document.getElementById('step-tailor');
                    const step4 = document.getElementById('step-edit');

                    if (step3 && step4) {
                        step3.classList.remove('active');
                        step3.classList.add('locked');
                        step3.setAttribute('aria-hidden', 'true');

                        step4.classList.remove('locked');
                        step4.classList.add('active');
                        step4.removeAttribute('aria-hidden');

                        // Update progress dots
                        const dot3 = document.querySelector('[data-step="3"]');
                        const dot4 = document.querySelector('[data-step="4"]');
                        if (dot3) {
                            dot3.classList.remove('active');
                            dot3.classList.add('completed');
                        }
                        if (dot4) {
                            dot4.classList.remove('locked');
                            dot4.classList.add('active');
                            dot4.setAttribute('aria-current', 'step');
                        }

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });

                        // Populate Step 4 editor and preview
                        populateStep4EditorAndPreview();
                    }
                });
            }

            // Step 4: Populate editor and preview
            function populateStep4EditorAndPreview() {
                console.log('[Workflow] Populating Step 4 editor and preview...');

                // Get resume text from workflowIntegration state
                let resumeText = '';
                if (workflowIntegration && workflowIntegration.state.resumeText) {
                    resumeText = workflowIntegration.state.resumeText;
                } else {
                    // Fallback to textarea value
                    const resumeTextArea = document.getElementById('resume-text');
                    if (resumeTextArea && resumeTextArea.value) {
                        resumeText = resumeTextArea.value;
                    }
                }

                if (!resumeText || resumeText.length < 10) {
                    console.warn('[Workflow] No resume text available for Step 4');
                    return;
                }

                // Populate editor (left panel) - PLAIN TEXT for editing
                const editor = document.getElementById('resume-editor');
                if (editor) {
                    // Show plain text for easy editing
                    editor.textContent = resumeText;
                    editor.style.fontFamily = 'monospace';
                    editor.style.fontSize = '14px';
                    editor.style.lineHeight = '1.6';
                    editor.style.padding = '1rem';
                    editor.style.color = 'var(--text-color)';
                    editor.style.whiteSpace = 'pre-wrap';
                    console.log('[Workflow] Editor populated with plain text');
                }

                // Populate preview (right panel) - use resumePreview instance if available
                const preview = document.getElementById('resume-preview');
                if (preview && window.resumePreview) {
                    window.resumePreview.updatePreview(resumeText);
                    console.log('[Workflow] Preview populated with formatted resume');
                } else if (preview) {
                    // Fallback if resumePreview not initialized
                    preview.innerHTML = `
                        <div class="resume-content" style="padding: 2rem; max-width: 800px; margin: 0 auto;">
                            ${formatResumeAsHTML(resumeText)}
                        </div>
                    `;
                    console.log('[Workflow] Preview populated (fallback method)');
                }

                // Apply default template (classic)
                const templateSelect = document.getElementById('template-select');
                if (templateSelect) {
                    const defaultTemplate = templateSelect.value || 'classic';
                    applyTemplateStyles(preview, defaultTemplate);
                }
            }

            // Helper function to format resume text as HTML
            function formatResumeAsHTML(text) {
                if (!text) return '';

                let html = text;

                // Escape HTML special characters
                html = html.replace(/&/g, '&amp;')
                           .replace(/</g, '&lt;')
                           .replace(/>/g, '&gt;');

                // Headers (lines in ALL CAPS or starting with #)
                html = html.replace(/^([A-Z\s]{3,})$/gm, '<h2 style="color: var(--text-color); font-size: 1.25rem; font-weight: 600; margin: 1.5rem 0 0.75rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;">$1</h2>');
                html = html.replace(/^#{1}\s+(.+)$/gm, '<h1 style="color: var(--text-color); font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem;">$1</h1>');
                html = html.replace(/^#{2}\s+(.+)$/gm, '<h2 style="color: var(--text-color); font-size: 1.25rem; font-weight: 600; margin: 1.5rem 0 0.75rem;">$1</h2>');
                html = html.replace(/^#{3}\s+(.+)$/gm, '<h3 style="color: var(--text-color); font-size: 1rem; font-weight: 600; margin: 1rem 0 0.5rem;">$1</h3>');

                // Bold (**text** or __text__)
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color: var(--text-color);">$1</strong>');
                html = html.replace(/__(.+?)__/g, '<strong style="color: var(--text-color);">$1</strong>');

                // Italic (*text* or _text_)
                html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
                html = html.replace(/_(.+?)_/g, '<em>$1</em>');

                // Links
                html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" style="color: var(--primary-color); text-decoration: underline;">$1</a>');

                // Email addresses
                html = html.replace(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi, '<a href="mailto:$1" style="color: var(--primary-color);">$1</a>');

                // Phone numbers
                html = html.replace(/(\d{3}[-.]?\d{3}[-.]?\d{4})/g, '<strong style="color: var(--text-color);">$1</strong>');

                // Bullet lists (-, *, ‚Ä¢)
                html = html.replace(/^[\-\*‚Ä¢]\s+(.+)$/gm, '<li style="margin: 0.25rem 0; color: var(--text-color);">$1</li>');
                html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/g, '<ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--text-color);">$&</ul>');

                // Line breaks to paragraphs
                html = html.split('\n\n').map(para => {
                    if (!para.match(/^<[h|u]/)) {
                        return `<p style="margin: 0.5rem 0; color: var(--text-color); line-height: 1.6;">${para.replace(/\n/g, '<br>')}</p>`;
                    }
                    return para;
                }).join('\n');

                return html;
            }

            // Step 4: Template selector
            const templateSelect = document.getElementById('template-select');
            if (templateSelect) {
                templateSelect.addEventListener('change', (e) => {
                    const template = e.target.value;
                    console.log('[Workflow] Template changed to:', template);

                    const preview = document.getElementById('resume-preview');
                    if (preview) {
                        // Remove existing template classes
                        preview.classList.remove('template-classic', 'template-modern', 'template-creative');

                        // Add new template class
                        preview.classList.add(`template-${template}`);

                        // Apply template-specific styles
                        applyTemplateStyles(preview, template);
                    }
                });
            }

            // Apply template styles to preview
            function applyTemplateStyles(preview, template) {
                const resumeContent = preview.querySelector('.resume-content');
                if (!resumeContent) return;

                // Reset styles
                resumeContent.style.cssText = 'padding: 2rem; max-width: 800px; margin: 0 auto;';

                switch(template) {
                    case 'classic':
                        resumeContent.style.fontFamily = 'Georgia, serif';
                        resumeContent.style.fontSize = '14px';
                        resumeContent.style.lineHeight = '1.6';
                        break;
                    case 'modern':
                        resumeContent.style.fontFamily = '-apple-system, BlinkMacSystemFont, sans-serif';
                        resumeContent.style.fontSize = '15px';
                        resumeContent.style.lineHeight = '1.7';
                        resumeContent.style.letterSpacing = '0.01em';
                        break;
                    case 'creative':
                        resumeContent.style.fontFamily = 'Arial, Helvetica, sans-serif';
                        resumeContent.style.fontSize = '14px';
                        resumeContent.style.lineHeight = '1.65';
                        resumeContent.style.background = 'linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%)';
                        resumeContent.style.borderRadius = '8px';
                        break;
                }

                console.log('[Workflow] Applied template:', template);
            }

            // Step 4 Continue button (Continue to Export)
            const step4ContinueBtn = document.getElementById('step-4-continue');
            if (step4ContinueBtn) {
                step4ContinueBtn.addEventListener('click', () => {
                    console.log('[Workflow] Step 4 Continue (to Export) clicked');

                    const step4 = document.getElementById('step-edit');
                    const step5 = document.getElementById('step-export');

                    if (step4 && step5) {
                        step4.classList.remove('active');
                        step4.classList.add('locked');
                        step4.setAttribute('aria-hidden', 'true');

                        step5.classList.remove('locked');
                        step5.classList.add('active');
                        step5.removeAttribute('aria-hidden');

                        // Update progress dots
                        const dot4 = document.querySelector('[data-step="4"]');
                        const dot5 = document.querySelector('[data-step="5"]');
                        if (dot4) {
                            dot4.classList.remove('active');
                            dot4.classList.add('completed');
                        }
                        if (dot5) {
                            dot5.classList.remove('locked');
                            dot5.classList.add('active');
                            dot5.setAttribute('aria-current', 'step');
                        }

                        // Scroll to top with smooth fade
                        smoothStepTransition(step4, step5);
                    }
                });
            }

            // Step 5 Continue button (to Additional Documents)
            const step5ContinueBtn = document.getElementById('step-5-continue');
            if (step5ContinueBtn) {
                step5ContinueBtn.addEventListener('click', () => {
                    console.log('[Workflow] Step 5 Continue (to Additional Documents) clicked');

                    const step5 = document.getElementById('step-export');
                    const step6 = document.getElementById('step-additional');

                    if (step5 && step6) {
                        step5.classList.remove('active');
                        step5.classList.add('locked');
                        step5.setAttribute('aria-hidden', 'true');

                        step6.classList.remove('locked');
                        step6.classList.add('active');
                        step6.removeAttribute('aria-hidden');

                        // Update progress dots
                        const dot5 = document.querySelector('[data-step="5"]');
                        const dot6 = document.querySelector('[data-step="6"]');
                        if (dot5) {
                            dot5.classList.remove('active');
                            dot5.classList.add('completed');
                        }
                        if (dot6) {
                            dot6.classList.remove('locked');
                            dot6.classList.add('active');
                            dot6.setAttribute('aria-current', 'step');
                        }

                        // Scroll to top with smooth fade
                        smoothStepTransition(step5, step6);
                    }
                });
            }

            // Step 6: Document generation handlers
            const generateCoverLetterBtn = document.getElementById('generate-cover-letter');
            const generateBrandStatementBtn = document.getElementById('generate-brand-statement');
            const generateExecutiveBioBtn = document.getElementById('generate-executive-bio');
            const generateFollowupLetterBtn = document.getElementById('generate-followup-letter');

            if (generateCoverLetterBtn) {
                generateCoverLetterBtn.addEventListener('click', () => generateDocument('cover-letter'));
            }
            if (generateBrandStatementBtn) {
                generateBrandStatementBtn.addEventListener('click', () => generateDocument('brand-statement'));
            }
            if (generateExecutiveBioBtn) {
                generateExecutiveBioBtn.addEventListener('click', () => generateDocument('executive-bio'));
            }
            if (generateFollowupLetterBtn) {
                generateFollowupLetterBtn.addEventListener('click', () => generateDocument('followup-letter'));
            }

            // LinkedIn Profile handlers
            const fetchLinkedInBtn = document.getElementById('fetch-linkedin-profile');
            const analyzeLinkedInBtn = document.getElementById('analyze-linkedin-profile');

            if (fetchLinkedInBtn) {
                fetchLinkedInBtn.addEventListener('click', async () => {
                    const urlInput = document.getElementById('linkedin-url');
                    const url = urlInput?.value.trim();

                    if (!url) {
                        alert('Please enter a LinkedIn profile URL');
                        return;
                    }

                    const loadingDiv = document.getElementById('additional-loading');
                    if (loadingDiv) loadingDiv.style.display = 'block';

                    try {
                        const response = await fetch('/api/fetch-job', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to fetch LinkedIn profile. Please paste your profile content manually.');
                        }

                        const result = await response.json();
                        const contentTextarea = document.getElementById('linkedin-content');
                        if (contentTextarea && result.content) {
                            contentTextarea.value = result.content;
                        }

                        if (loadingDiv) loadingDiv.style.display = 'none';
                        alert('Profile fetched! Review the content and click Analyze.');
                    } catch (error) {
                        console.error('[Workflow] LinkedIn fetch error:', error);
                        if (loadingDiv) loadingDiv.style.display = 'none';
                        alert(error.message || 'Failed to fetch profile. Please paste your content manually.');
                    }
                });
            }

            if (analyzeLinkedInBtn) {
                analyzeLinkedInBtn.addEventListener('click', () => {
                    const contentTextarea = document.getElementById('linkedin-content');
                    const content = contentTextarea?.value.trim();

                    if (!content || content.length < 50) {
                        alert('Please provide your LinkedIn profile content (paste or fetch from URL)');
                        return;
                    }

                    generateDocument('linkedin-review', content);
                });
            }

            // Generate document function
            async function generateDocument(type, linkedinContent = null) {
                console.log('[Workflow] Generating document:', type);

                const loadingDiv = document.getElementById('additional-loading');
                const contentDiv = document.getElementById('generated-content');
                const textDiv = document.getElementById('generated-text');

                // Show loading
                if (loadingDiv) loadingDiv.style.display = 'block';
                if (contentDiv) contentDiv.style.display = 'none';

                try {
                    const resumeText = workflowIntegration?.state.resumeText || '';
                    const jobDescription = workflowIntegration?.state.jobDescription || '';

                    if (!resumeText) {
                        throw new Error('No resume found. Please complete the resume workflow first.');
                    }

                    const apiKey = workflowIntegration?.getApiKey();
                    if (!apiKey && !workflowIntegration?.serverHasKey) {
                        throw new Error('No API key available. Please configure an API key.');
                    }

                    // Call generate API
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: getDocumentPrompt(type, resumeText, jobDescription, linkedinContent),
                            apiKey: apiKey || undefined
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Generation failed');
                    }

                    const result = await response.json();
                    const generatedText = result.content || result.text || '';

                    // Display result
                    if (textDiv) textDiv.textContent = generatedText;
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (contentDiv) {
                        contentDiv.style.display = 'block';
                        contentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }

                    // Store for copy/download
                    window.lastGeneratedDocument = { type, content: generatedText };

                } catch (error) {
                    console.error('[Workflow] Document generation error:', error);
                    alert('Generation failed: ' + error.message);
                    if (loadingDiv) loadingDiv.style.display = 'none';
                }
            }

            // Get document prompt based on type
            function getDocumentPrompt(type, resumeText, jobDescription, linkedinContent) {
                const prompts = {
                    'cover-letter': `Based on the following resume and job description, create a professional, compelling cover letter that highlights relevant experience and skills. The letter should be 3-4 paragraphs, personable yet professional.

Resume:
${resumeText}

Job Description:
${jobDescription || 'General position'}

Create a tailored cover letter that makes a strong case for why this candidate is perfect for the role.`,

                    'brand-statement': `Based on the following resume, create a powerful executive brand statement (2-3 paragraphs) that captures the professional's unique value proposition, key achievements, and leadership style. This should be suitable for LinkedIn "About" section and networking. Write in first person.

Resume:
${resumeText}

Create a compelling professional brand statement in first person that showcases unique value and leadership style.`,

                    'executive-bio': `Based on the following resume, create a professional third-person executive bio (150-200 words) suitable for conference programs, press releases, speaker introductions, and professional media kits.

Resume:
${resumeText}

Create a concise, impactful third-person bio that highlights key achievements, expertise, and professional credentials. Use third person (he/she/they) throughout.`,

                    'followup-letter': `Based on the following resume and job description, create a professional status inquiry (follow-up) letter to politely check on the application status. The letter should be:
- Brief and professional (3-4 short paragraphs)
- Express continued interest in the position
- Politely request an update on the hiring timeline
- Reaffirm qualifications without being pushy
- Include appropriate subject line

Resume:
${resumeText}

Job Description:
${jobDescription || 'the position I applied for'}

Create a courteous, professional follow-up letter that demonstrates continued interest while respecting the hiring manager's time.`,

                    'linkedin-review': `You are a LinkedIn optimization expert conducting a comprehensive profile analysis. Analyze the following LinkedIn profile and provide a detailed optimization report with scoring and actionable recommendations.

LinkedIn Profile Content:
${linkedinContent || 'No profile content provided'}

Resume for Context:
${resumeText}

Job Target for Keyword Analysis:
${jobDescription || 'General professional advancement'}

Provide a comprehensive analysis structured as follows:

## PROFILE SCORE: [X/100]
Provide an overall score based on completeness, keyword optimization, and professional presentation.

## SCORING BREAKDOWN:
- Headline Strength: [X/20]
- Summary/About Quality: [X/20]
- Work Experience Depth: [X/20]
- Skills & Keywords: [X/15]
- Profile Completeness: [X/15]
- ATS Keyword Match: [X/10]

## BASIC INFORMATION ANALYSIS:
- Profile Photo: [Present/Missing] - Recommendation
- Headline: Current effectiveness and improvement suggestions
- Contact Info: Completeness check
- Custom URL: Status and recommendation

## HIGH IMPACT IMPROVEMENTS:
Identify the top 3-5 changes that will have the biggest impact on profile visibility and recruiter appeal.

## HEADLINE OPTIMIZATION:
**Current:** [Extract current headline]
**Recommended:** [Provide optimized version]
**Why:** [Explain the improvement]

## ABOUT/SUMMARY SECTION:
**Current Status:** [Analyze current content]
**Keyword Gaps:** [Identify missing keywords from job description]
**Recommended Improvements:** [Provide specific suggestions]
**Example Rewrite:** [Provide first paragraph rewrite as example]

## WORK EXPERIENCE:
For top 2-3 positions, provide:
- Current description effectiveness
- Missing impact metrics or achievements
- Keyword optimization opportunities
- Before/After examples

## SKILLS SECTION:
- Current Skills Assessment: [Evaluate alignment with target role]
- Missing Critical Keywords: [List from job description]
- Recommended Additions: [Specific skills to add]
- Skills to Prioritize: [Top 5 skills to feature]

## EDUCATION & CERTIFICATIONS:
- Completeness check
- Recommendations for additional certifications

## TIPS & ACTIONABLE NEXT STEPS:
1. [Immediate action item with specific instruction]
2. [Immediate action item with specific instruction]
3. [Immediate action item with specific instruction]
4. [Medium-term improvement]
5. [Long-term profile strategy]

## KEYWORD FREQUENCY ANALYSIS:
Compare profile keyword usage vs. target job description:
- [Keyword 1]: Used X times (Target: Y times) - [Status: Good/Needs Improvement]
- [Keyword 2]: Used X times (Target: Y times) - [Status: Good/Needs Improvement]
- [Add 5-7 critical keywords]

## LINKEDIN SEARCH VISIBILITY:
- Current searchability assessment for target role
- Recommended keyword placement strategies
- Hashtag and content posting recommendations

Provide detailed, personalized recommendations with specific before/after examples for each major section.`
                };

                return prompts[type] || prompts['cover-letter'];
            }

            // Copy to clipboard
            const copyBtn = document.getElementById('copy-generated');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const text = document.getElementById('generated-text')?.textContent;
                    if (text) {
                        navigator.clipboard.writeText(text).then(() => {
                            copyBtn.textContent = '‚úÖ Copied!';
                            setTimeout(() => {
                                copyBtn.innerHTML = 'üìã Copy to Clipboard';
                            }, 2000);
                        });
                    }
                });
            }

            // Download document
            const downloadBtn = document.getElementById('download-generated');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    const doc = window.lastGeneratedDocument;
                    if (doc && doc.content) {
                        const blob = new Blob([doc.content], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${doc.type}-${Date.now()}.txt`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                });
            }

            // Step 6 Finish button
            const step6FinishBtn = document.getElementById('step-6-finish');
            if (step6FinishBtn) {
                step6FinishBtn.addEventListener('click', () => {
                    if (confirm('Start a new resume? This will clear all current data.')) {
                        location.reload();
                    }
                });
            }

            // Smooth step transition with fade
            function smoothStepTransition(fromStep, toStep) {
                // Fade out current step
                fromStep.style.opacity = '1';
                fromStep.style.transition = 'opacity 0.3s ease-out';
                fromStep.style.opacity = '0';

                setTimeout(() => {
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'auto' });

                    // Fade in new step
                    toStep.style.opacity = '0';
                    toStep.style.transition = 'opacity 0.3s ease-in';

                    setTimeout(() => {
                        toStep.style.opacity = '1';
                    }, 50);
                }, 300);
            }

            // Step 2: Analysis
            // Override the startAnalysis method
            if (workflowUI) {
                const originalStartAnalysis = workflowUI.startAnalysis.bind(workflowUI);
                workflowUI.startAnalysis = async function() {
                    console.log('[Workflow] Starting analysis with backend integration...');
                    this.goToNextStep();

                    if (workflowIntegration) {
                        try {
                            await workflowIntegration.analyzeResume();
                        } catch (error) {
                            console.error('[Workflow] Analysis error:', error);
                        }
                    }
                };
            }

            // Step 3: Job tailoring (job input now in Step 1)
            // Override the startTailoring method
            if (workflowUI) {
                const originalStartTailoring = workflowUI.startTailoring.bind(workflowUI);
                workflowUI.startTailoring = async function() {
                    console.log('[Workflow] Starting tailoring with backend integration...');

                    if (workflowIntegration) {
                        try {
                            await workflowIntegration.tailorResume();
                            this.goToNextStep();
                        } catch (error) {
                            console.error('[Workflow] Tailoring error:', error);
                        }
                    }
                };
            }

            // Step 5: Export
            const exportButtons = document.querySelectorAll('.btn-export');
            exportButtons.forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const format = btn.dataset.format;
                    if (workflowIntegration) {
                        try {
                            await workflowIntegration.exportDocument(format);
                        } catch (error) {
                            console.error('[Workflow] Export error:', error);
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
